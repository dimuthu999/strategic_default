---
title: "Mortgage Payment Size and Default"
output: 
  html_document: 
    css: bodycss.css
    fig_height: 6
    fig_width: 12
    toc: yes
    number_section: yes
---

<style type="text/css">
body{ 
      font-size: 15px;
      font-family: Helvetica,Arial,sans-serif;
      line-height: 200%;
  }
  
.author {
 font-size: 15px;
 color: Black;
 font-style: normal;
 text-align: center;
}


.date { 
 font-size: 15px;
 color: Black;
 font-style: normal;
 text-align: center;
}

.title{
  text-align: center;
  font-size: 15px;
 color: Black;
 
}

.toc-ignore{
  text-align: center;
  font-size: 15px;
 color: Black;
}

.fluid-row{
  text-align: center;
  font-size: 15px;
 color: Black;
}

</style>

```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE,echo=FALSE)
```

```{r echo=FALSE}
rm(list=ls())
library(data.table)
library(zoo)
library(sqldf)
library(stargazer)
library(survival)
library(reshape2)
library(zipcode)
library(ggplot2)
library(multiwayvcov)
library(sandwich)
library(Matching)
library(AER)
library(FinCal)
library(ggplot2)
library(reshape2)
library(scales)
library(pracma)
library(plyr)
library(lfe)
library(dplyr)
library(np)
library(DataCombine)
file_path = "E:/strategic_default"
setwd(file_path)


output.type = "text"

completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}


# mtgrates <- read.csv(file="MORTGAGE30US.csv")
# mtgrates$date <- as.Date(mtgrates$date,origin="1900-01-01")
# mtgrates$date <- as.Date(paste(substr(as.character(mtgrates$date),1,7),"-01",sep=""))
# mtgrates <- ddply(mtgrates,.(date),summarise,mtg30us=median(mtg30us,na.rm = TRUE))
# 
# tbondrates <- read.csv(file="GS10.csv",stringsAsFactors = FALSE)
# tbondrates$month <- as.Date(tbondrates$month)
# 
# rent <- read.csv("Zip_MedianRentalPrice_Sfr.csv")
# rent <- data.frame(rent[1], stack(rent[7:ncol(rent)]))
# rent$ind <- as.character(rent$ind)
# rent['month']<- as.Date(paste(substr(rent$ind,2,5),substr(rent$ind,7,8),"01",sep = "-"))
# rent$ind <- NULL
# names(rent)<-c("zip","rent","month")
# rent['zip']<-(rent$zip %/% 100)*100
# rent <- rent[rent$month>='2011-01-01' & rent$month<'2012-01-01',]
# rent <- ddply(rent,.(zip),summarise,rent=median(rent,na.rm = TRUE))
# 
# hpi <- read.csv("Zip_Zhvi_SingleFamilyResidence.csv")
# hpi <- data.frame(hpi[2], stack(hpi[8:ncol(hpi)]))
# names(hpi)<-c("zip","value","month")
# hpi$zip <- floor(hpi$zip/100)*100
# hpi$month <- as.Date(paste(substr(hpi$month,2,5),substr(hpi$month,7,8),"01",sep = "-"))
# hpi$value <- as.double(hpi$value)
# hpi <- hpi[hpi$month>='2011-01-01' & hpi$month<'2012-01-01',]
# hpi <- hpi[hpi$zip %in% unique(rent$zip),]
# hpi <- ddply(hpi,.(zip),summarise,value=median(value,na.rm = TRUE))
# 
# rent <- merge(rent,hpi,by="zip")
# rent <- na.omit(rent)
# rent['rent_value'] <- rent$rent/rent$value
# rent['rent_quartiles'] <- ntile(rent$rent,4)
# rent['rent_value_quartiles'] <- ntile(rent$rent_value,4)
# rent <- na.omit(rent)
# rent$rent <- NULL
# rent$value <- NULL
# 
# 
# rent_ts <- read.csv("Zip_MedianRentalPrice_Sfr.csv")
# rent_ts <- data.frame(rent_ts[1], stack(rent_ts[7:ncol(rent_ts)]))
# rent_ts$ind <- as.character(rent_ts$ind)
# rent_ts['month']<- as.Date(paste(substr(rent_ts$ind,2,5),substr(rent_ts$ind,7,8),"01",sep = "-"))
# rent_ts$ind <- NULL
# names(rent_ts)<-c("zip","rent","month")
# rent_ts['zip']<-(rent_ts$zip %/% 100)*100
# rent_ts <- rent_ts[complete.cases(rent_ts),]
# rent_ts <- ddply(rent_ts,.(month,zip),summarise,rent=median(rent,na.rm = TRUE))
# 
# hpi <- read.csv("Zip_Zhvi_SingleFamilyResidence.csv")
# hpi <- data.frame(hpi[2], stack(hpi[8:ncol(hpi)]))
# names(hpi)<-c("zip","value","month")
# hpi$zip <- floor(hpi$zip/100)*100
# hpi$month <- as.Date(paste(substr(hpi$month,2,5),substr(hpi$month,7,8),"01",sep = "-"))
# hpi$value <- as.double(hpi$value)
# hpi <- hpi[hpi$zip %in% unique(rent_ts$zip),]
# hpi <- ddply(hpi,.(month,zip),summarise,value=median(value,na.rm = TRUE))
# 
# rent_ts <- merge(rent_ts,hpi,by=c("zip","month"))
# rent_ts['rent_value_ts'] <- rent_ts$rent/rent_ts$value
# temp <- ddply(rent_ts,.(zip),summarize,rent_value_ts_med = median(rent_value_ts,na.rm = TRUE))
# rent_ts <- merge(rent_ts,temp,by="zip")
# rent_ts['rent_value_ts_ntile']<-ntile(rent_ts$rent_value_ts_med,10)
# rent_ts$rent <- NULL
# rent_ts$value <- NULL
# 
# forc_delay <- readRDS(file="foreclosure_months_summary.rds")
# forc_delay <- as.data.frame(forc_delay)
# forc_delay$current_year <- forc_delay$current_year+1
# forc_delay['forc_time_qt'] <- ntile(forc_delay$months_in_foreclosure,4)
# ###########################################################
# # loan_data
# file_names <- c("cox_ne_-0.1new_Apr282017_60day.rds","cox_ne_-0.2new_Apr282017_60day.rds","cox_ne_-0.3_Apr282017_60day.rds","cox_ne_-0.4_Apr282017_60day.rds","cox_ne_-0.5_Apr282017_60day.rds")
# #
# loan_data <- NULL
# 
# for(fn in file_names){
#   print(fn)
#   temp <- readRDS(file=fn)
# 
#   temp <- temp[!duplicated(temp[,c("loanid")]),]
# 
#   temp <- merge(temp,mtgrates,by.x=c("orgdate"),by.y = c("date"))
#   temp <- merge(temp,tbondrates,by.x=c("orgdate"),by.y = c("month"))
#   temp['mpay_value'] <- temp$mpay/temp$current_housevalue
#   temp['interest_diff'] <- temp$interestrate - temp$mtg30us
#   temp['ne_year'] <- as.numeric(format(as.Date(as.character(temp$current_date)),"%Y"))
#   temp['zip_year'] <- paste(temp$zip,temp$ne_year,sep="_")
#   temp['org_year'] <- as.numeric(format(temp$orgdate,"%Y"))
#   if(median(temp$ne_cutoff,na.rm = TRUE)==-0.5)  temp$ org_year <- ifelse(temp$org_year<=2007 & temp$org_year>=2004,2005,ifelse(temp$org_year<=2011 & temp$org_year>=2008,2010,ifelse(temp$org_year<=2003,2000,2013)))
#   temp['zip_orgyear'] <- paste(temp$zip,temp$org_year,sep="_")
# 
# 
#   temp <- merge(temp,rent,by=c("zip"),all.x = TRUE)
#   temp <- merge(temp,rent_ts,by.x =c("zip","current_date"),by.y=c("zip","month"),all.x = TRUE)
#   temp <- merge(temp,forc_delay,by.x=c("zip","ne_year"),by.y = c("zip","current_year"),all.x = TRUE)
# 
#   loan_data = rbind(loan_data,temp)
# }
# 
# property_tax <- readRDS("prop_tax.rds")
# 
# loan_data <- merge(loan_data,property_tax,by="zip",all.x = TRUE)
# loan_data['prop_tax_value'] <- (loan_data$current_housevalue*loan_data$prop_tax_pct)/12
# loan_data$mpay <- loan_data$mpay+loan_data$prop_tax_value*0.8+loan_data$upb*(100/loan_data$ltv)*0.01/12-loan_data$currentupb_t*loan_data$interestrate*0.2/1200
# 
# # adjusted for property taxes, maintainance costs and tax benefit on interest
# loan_data['mpay_value_2'] <- loan_data$mpay/loan_data$current_housevalue
# 
# saveRDS(loan_data,file="loan_data_May72017.rds")

loan_data <- readRDS(file="loan_data_May72017.rds")

loan_data['fico_cat'] <- ntile(loan_data$fico,4)

loan_data_pe <- readRDS(file="loan_data_pos_eqty_Apr262017.rds")

cluster_by = "zip_year"

note =c("Fixed Effects: zip x ne year, zip x org year","Standard Errors clustered by zip x ne year")
printtable <- function(reg,column.labels,depvar,note,iv,lines) {
  stargazer(reg,type=output.type,no.space = TRUE,omit.stat = c("f","rsq","ser"),notes= note,column.labels = column.labels, dep.var.labels = "",dep.var.caption   = paste("Y: ",gsub("_"," ",depvar),"; iv: ",gsub("_"," ",iv)),dep.var.labels.include = FALSE,add.lines = lines)
}



```

# Data
## Data Sources

* Freddie Mac's Single Family Loan-Level Dataset (Downloaded in November 2016) (http://www.freddiemac.com/news/finance/sf_loanlevel_dataset.html). 
  * Origination data cleaning: https://github.com/dimuthu999/strategic_default/blob/master/Create%20Origination%20Data.R
  * Performance data cleaning: https://github.com/dimuthu999/strategic_default/blob/master/Apr2017_create_performance_rds.R
* Zillow's ZHVI Single-Family Homes Time Series (http://files.zillowstatic.com/research/public/Zip/Zip_Zhvi_SingleFamilyResidence.csv)
* Zillow's Median Rent List Price ($), Single-Family Residence (http://files.zillowstatic.com/research/public/Zip/Zip_MedianRentalPrice_Sfr.csv)
* 30-Year Fixed Rate Mortgage Average in the United States (https://fred.stlouisfed.org/series/MORTGAGE30US)
* 10-Year Treasury Constant Maturity Rate (https://fred.stlouisfed.org/series/GS10)
* Zip code level mean property tax rates (https://taxfoundation.org/data/)

## Sample Construction

* Only include mortgages that satisfy the following criteria. 30 year, fixed rate, single family, owner occupied and new purchases. We exclude the loans that were modified.
* Using the ZHVI indices, calculate home equity for every borrower for every month
* Identify the time at which each borrower's equity <b>first</b> drops below a certain threshold (-10%, -20%,..., -50%).
* Observe the following 12 months after reaching the threshold and identify the mortgages that went in to 60 day delinquency or prepaid during this 12 months
* Code used to create the negative equity samples are available at https://github.com/dimuthu999/strategic_default/blob/master/Apr2017_Create_NE_Samples.R
* Monthly mortgage payment was calculated using loan amount, loan term and interest rate. Mortgage payment was adjusted to include the property tax payments, maintainance cost (1% of value per year) and tax savings on interest (assuming a 20% income tax rate)
* Time to complete foreclosure was calculated for each zip code-year by using the foreclosures completed in each zip code-year (Code: https://github.com/dimuthu999/strategic_default/blob/master/Apr2017_create_foreclosuretime_rds.R)
* Positive equity samples were constructed using the same method. i.e. a mortgage enteres in to the positive equity sample when it first reaches the threshold from below. Code : https://github.com/dimuthu999/strategic_default/blob/master/Apr2017_Create_PE_Samples.R


# Descriptive Statistics

Panel A provides descriptive statistics of the 30% negative equity sample. Panel B provides descriptive statistics of 30% positive equity sample.

## Panel A: 30% Negative Equity
```{r ne30_desc}

stargazer(loan_data[loan_data$ne_cutoff==-0.3, c("def","prepaid","mpay_value","rent_value","fico","mpay","ltv","dti","upb","interestrate","org_year","ne_year")], type = output.type, summary.stat = c("mean", "sd", "p25", "median", "p75", "n"),notes = "",digits = 5)
```

## Panel B: 30% Positive Equity
```{r pe30_desc}

temp <- loan_data_pe[loan_data_pe$ne_cutoff %in% c(0.3),]
temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))

stargazer(temp[, c("def","prepaid","mpay_value","rent_value","fico","mpay","ltv","dti","upb","interestrate","org_year","ne_year")], type = output.type, summary.stat = c("mean", "sd", "p25", "median", "p75", "n"),notes = "",digits = 5)
```

## Negative Equity sample summary
```{r sample_summary}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.1,-0.2,-0.3,-0.4,-0.5),]
sample_sum <- ddply(temp,.(ne_cutoff),summarise,mortgage_to_value=mean(mpay_value,na.rm=TRUE)*100,default_rate = mean(def,na.rm=TRUE)*100,prepayment_rate = mean(prepaid,na.rm=TRUE)*100)
stargazer(sample_sum,summary = FALSE,type=output.type,notes="In percent")

```

<a href="#top">Back to top</a>

<hr/>

# NEGATIVE EQUITY

## Default OLS

This table provides OLS estimates of the relationship between default and mortgage-to-value for each negative equity sample. $Default$ equals 1 if the mortgage becomes 60 days delinquent after reaching the respective negative equity threshold. $Mortgage-to-value=\frac{Mortgage\text{ }}$
```{r ne_ols}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.1,-0.2,-0.3,-0.4,-0.5),]
temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))

formula <- as.formula("def~fico+ltv+log(upb)+dti+mpay_value|factor(zip_year)+factor(zip_orgyear)|0|zip_year")


felm_regs <- list()
felm_regs[[1]] <- felm(formula,data=temp[temp$ne_cutoff==-0.1,])
felm_regs[[2]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2,])
felm_regs[[3]] <- felm(formula,data=temp[temp$ne_cutoff==-0.3,])
felm_regs[[4]] <- felm(formula,data=temp[temp$ne_cutoff==-0.4,])
felm_regs[[5]] <- felm(formula,data=temp[temp$ne_cutoff==-0.5,])

printtable(felm_regs,"","default",note,"none","")

```

<a href="#top">Back to top</a>


## Negative Equity: First Stage
```{r ne_firststage}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.1,-0.2,-0.3,-0.4,-0.5),]
temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))
temp$mpay_value  = temp$mpay_value * 100000
formula <- as.formula("mpay_value~mtg30us+fico+ltv+log(upb)+dti|factor(zip_year)+factor(org_year)|0|zip_year")

iv_reg_1st <- list()
iv_reg_1st[[1]] <- felm(formula, data=temp[temp$ne_cutoff==-0.1,])
iv_reg_1st[[2]] <- felm(formula, data=temp[temp$ne_cutoff==-0.2,])
iv_reg_1st[[3]] <- felm(formula, data=temp[temp$ne_cutoff==-0.3,])
iv_reg_1st[[4]] <- felm(formula, data=temp[temp$ne_cutoff==-0.4,])
iv_reg_1st[[5]] <- felm(formula, data=temp[temp$ne_cutoff==-0.5,])

printtable(iv_reg_1st,"","mpay value",note,"none","")
```

<a href="#top">Back to top</a>

## Univariate Evidence - Nadarayaâ€“Watson (30% Negative equity sample)

* FE adjusted mortgage-to-value = mortgage-to-value - predicted mortgage-to-value from (mortgage-to-value~ zip * ne year + zip * org year)
* Results are similar for other levels of negative equity

```{r figure}
library(np)
# temp <- loan_data[loan_data$ne_cutoff == -0.3,]
# temp <- completeFun(temp,c("mtg30us","mpay_value","zip_year","zip_orgyear"))
# 
# adj_mpay_value <- felm(mpay_value~0|factor(zip_year)+factor(zip_orgyear),data=temp)
# adj_mtg30us <- felm(mtg30us~0|factor(zip_year)+factor(zip_orgyear),data=temp)
# temp['resid_mpay_value'] <- adj_mpay_value$residuals*10000#floor(adj_mpay_value$residuals*100000)/100
# temp['resid_mtg30us'] <- adj_mtg30us$residuals*100#floor(adj_mtg30us$residuals*100)/100
# 
# temp <- temp[temp$resid_mpay_value <= quantile(temp$resid_mpay_value,0.95,na.rm = TRUE) & temp$resid_mpay_value >= quantile(temp$resid_mpay_value,0.05,na.rm = TRUE),]
# # temp$resid_mpay_value <- floor(temp$resid_mpay_value/5)*5/1e5
# 
# adj_default <- felm(def~0|factor(zip_year)+factor(zip_orgyear),data=temp)
# temp['resid_default'] <- adj_default$residuals#  floor(adj_default$residuals*100)/100
# 
# temp <- temp[,c("resid_mtg30us","resid_mpay_value","resid_default")]
# temp <- temp[complete.cases(temp),]
# 
# bw <- npregbw(formula=as.vector(temp$resid_default)~as.vector(temp$resid_mpay_value),bws=0.75,bwtype="fixed",bandwidth.compute=F)
# model <- npreg(bws=bw,gradients = TRUE)
# plot.out <- plot(model, plot.errors.method="asymptotic",plot.errors.style="band",plot.behavior="data")
# y.eval <- fitted(plot.out$r1)
# x.eval <- plot.out$r1$eval[,1]/10000+mean(loan_data[loan_data$ne_cutoff==-0.3,]$mpay_value,na.rm=TRUE)
# y.se <- se(plot.out$r1)
# y.lower.ci <- y.eval+1.96*y.se[,1]
# y.upper.ci <- y.eval+1.96*y.se[,2]
# df <- as.data.frame(cbind(x.eval,y.eval,y.lower.ci,y.upper.ci))
# saveRDS(df,file="figure_panelA.rds")

df <- readRDS(file="figure_panelA.rds")
df$y.eval = df$y.eval+ mean(loan_data[loan_data$ne_cutoff==-0.3,]$def,na.rm=TRUE)
df$y.lower.ci = df$y.lower.ci+ mean(loan_data[loan_data$ne_cutoff==-0.3,]$def,na.rm=TRUE)
df$y.upper.ci = df$y.upper.ci+ mean(loan_data[loan_data$ne_cutoff==-0.3,]$def,na.rm=TRUE)
df <- melt(df,id="x.eval")
df <- df[df$x.eval>0.008 & df$x.eval<0.009,]
g1 <-  ggplot(df,aes(x=x.eval, y=value,colour=variable)) + geom_line(aes(linetype=variable), size=1) +scale_linetype_manual(values = c(1,2,2))+scale_colour_manual(values=c("black","gray40","gray40"))+ theme_bw()+ylab("FE adjusted default rate") + xlab("FE adjusted median mortgage-to-value")+ labs(title = "Panel A")+ theme(legend.position="none")
g1
```


```{r}
# bw <- npregbw(formula=as.vector(temp$resid_mpay_value)~as.vector(temp$resid_mtg30us),bws=2,bwtype="fixed",bandwidth.compute=F)
# model <- npreg(bws=bw,gradients = TRUE)
# plot.out <- plot(model, plot.errors.method="asymptotic",plot.errors.style="band",plot.behavior="data")
# y.eval <- fitted(plot.out$r1)/10000+mean(loan_data[loan_data$ne_cutoff==-0.3,]$mpay_value,na.rm=TRUE)
# x.eval <- plot.out$r1$eval[,1]/100+mean(loan_data[loan_data$ne_cutoff==-0.3,]$mtg30us,na.rm=TRUE)
# y.se <- se(plot.out$r1)/10000
# y.lower.ci <- y.eval+1.96*y.se[,1]
# y.upper.ci <- y.eval+1.96*y.se[,2]
# df <- as.data.frame(cbind(x.eval,y.eval,y.lower.ci,y.upper.ci))
# saveRDS(df,file="figure_panelB.rds")

df <- readRDS(file="figure_panelB.rds")
df <- melt(df,id="x.eval")
df <- df[df$value>quantile(df$value,0.03,na.rm=TRUE) & df$value <quantile(df$value,0.97,na.rm=TRUE),]
df <- df[df$x.eval>5.75 & df$x.eval<6.8,]
g2 <- ggplot(df,aes(x=x.eval, y=value,colour=variable)) + geom_line(aes(linetype=variable), size=1) +scale_linetype_manual(values = c(1,2,2))+scale_colour_manual(values=c("black","gray40","gray40"))+ theme_bw()+ylab("FE adjusted median mortgage-to-value") + xlab("FE adjusted 30 year fixed rate mortgage rate")+ labs(title = "Panel B")+ theme(legend.position="none")
g2

```

<a href="#top">Back to top</a>




## Negative Equity: IV Regressions

```{r ne_iv}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.1,-0.2,-0.3,-0.4,-0.5) ,]
temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))

formula <- as.formula("def~fico+ltv+log(upb)+dti|factor(zip_year)+factor(zip_orgyear)|(mpay_value~mtg30us)|zip_year")


felm_regs <- list()
felm_regs[[1]] <- felm(formula,data=temp[temp$ne_cutoff==-0.1,])
felm_regs[[2]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2,])
felm_regs[[3]] <- felm(formula,data=temp[temp$ne_cutoff==-0.3,])
felm_regs[[4]] <- felm(formula,data=temp[temp$ne_cutoff==-0.4,])
felm_regs[[5]] <- felm(formula,data=temp[temp$ne_cutoff==-0.5,])

condf <- c("Cond. F. Stat",round(condfstat(felm_regs[[1]])[[1]],2),round(condfstat(felm_regs[[2]])[[1]],2),round(condfstat(felm_regs[[3]])[[1]],2),round(condfstat(felm_regs[[4]])[[1]],2),round(condfstat(felm_regs[[5]])[[1]],2))

printtable(felm_regs,"","default",note,"mtg30us",list(condf))

```

<a href="#top">Back to top</a>

## Negative Equity: IV Regressions (Treasury Bond Rate)

```{r ne_iv_tb10}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.1,-0.2,-0.3,-0.4,-0.5) ,]
temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))

formula <- as.formula("def~fico+ltv+log(upb)+dti|factor(zip_year)+factor(zip_orgyear)|(mpay_value~gs10)|zip_year")


felm_regs <- list()
felm_regs[[1]] <- felm(formula,data=temp[temp$ne_cutoff==-0.1,])
felm_regs[[2]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2,])
felm_regs[[3]] <- felm(formula,data=temp[temp$ne_cutoff==-0.3,])
felm_regs[[4]] <- felm(formula,data=temp[temp$ne_cutoff==-0.4,])
felm_regs[[5]] <- felm(formula,data=temp[temp$ne_cutoff==-0.5,])

condf <- c("Cond. F. Stat",round(condfstat(felm_regs[[1]])[[1]],2),round(condfstat(felm_regs[[2]])[[1]],2),round(condfstat(felm_regs[[3]])[[1]],2),round(condfstat(felm_regs[[4]])[[1]],2),round(condfstat(felm_regs[[5]])[[1]],2))

printtable(felm_regs,"","default",note,"mtg30us",list(condf))

```

## Split by FICO (20% NE Sample)
```{r fico_split}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.2) ,]
temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))

formula <- as.formula("def~fico+ltv+log(upb)+dti|factor(zip_year)+factor(zip_orgyear)|(mpay_value~mtg30us)")


felm_regs <- list()
felm_regs[[1]] <- felm(formula,data=temp[temp$fico_cat==1,])
felm_regs[[2]] <- felm(formula,data=temp[temp$fico_cat==2,])
felm_regs[[3]] <- felm(formula,data=temp[temp$fico_cat==3,])
felm_regs[[4]] <- felm(formula,data=temp[temp$fico_cat==4,])


printtable(felm_regs,c("Q1 - 662","Q2 - 712","Q3 - 752","Q4 - 787"),"default",note,"mtg30us",list(""))

```

## Graphical Illustration
```{r graphical_illustration_ne}
# ne_cuts <- c(-0.1,-0.3,-0.5)
# formula_first_stage <- as.formula("mpay_value~mtg30us|factor(zip_year)+factor(org_year)")
# 
# df_all <- NULL
# for(cut in ne_cuts){
#   print(cut)
#   temp <- loan_data[loan_data$ne_cutoff %in% c(cut),]
#   temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))
# 
# 
#   first_stage <- lm(mpay_value~mtg30us+factor(zip_year)+factor(zip_orgyear), data=temp)
#   temp['mpay_value_fit'] <- predict(first_stage)*10000
#   temp['std_mpay_value_fit'] <- (temp$mpay_value_fit - mean(temp$mpay_value_fit,na.rm=TRUE))/sd(temp$mpay_value_fit,na.rm = TRUE)
#   temp <- temp[temp$std_mpay_value_fit>-4 & temp$std_mpay_value_fit<4,]
# 
#   # adj_mpay_value <- felm(mpay_value_fit~0|factor(zip_year)+factor(zip_orgyear),data=temp)
#   # temp['resid_mpay_value_fit'] <- adj_mpay_value$residuals*10000
#   adj_default <- felm(def~0|factor(zip_year)+factor(zip_orgyear),data=temp)
#   temp['resid_default'] <- adj_default$residuals
# 
# 
#   bw <- npregbw(formula=as.vector(temp$def)~as.vector(temp$std_mpay_value_fit),bws=0.35,bwtype="fixed",bandwidth.compute=F)
#   model <- npreg(bws=bw,gradients = TRUE)
#   plot.out <- plot(model, plot.errors.method="asymptotic",plot.errors.style="band",plot.behavior="data")
#   y.eval <- fitted(plot.out$r1)
#   x.eval <- plot.out$r1$eval[,1]
#   df <- as.data.frame(cbind(x.eval,y.eval))
#   df['ne_cutoff'] <- cut
#   df_all <- rbind(df_all,df)
#   gc()
# }
# 
# saveRDS(df_all,file="kernal_regs_4.rds")

df_all <- readRDS(file="kernal_regs_3.rds")
# df_all$y.eval <- ifelse(df_all$ne_cutoff==-0.1,df_all$y.eval + mean(loan_data[loan_data$ne_cutoff==-0.1,]$def,na.rm=TRUE),ifelse(df_all$ne_cutoff==-0.3,df_all$y.eval + mean(loan_data[loan_data$ne_cutoff==-0.3,]$def,na.rm=TRUE),df_all$y.eval + mean(loan_data[loan_data$ne_cutoff==-0.5,]$def,na.rm=TRUE)))
# df_all$x.eval <- df_all$x.eval/10000+mean(loan_data[loan_data$ne_cutoff==-0.3,]$mpay_value,na.rm=TRUE)
# df_all$x.eval <- ifelse(df_all$ne_cutoff==-0.1,df_all$x.eval + mean(loan_data[loan_data$ne_cutoff==-0.1,]$mpay_value,na.rm=TRUE),ifelse(df_all$ne_cutoff==-0.3,df_all$x.eval + mean(loan_data[loan_data$ne_cutoff==-0.3,]$mpay_value,na.rm=TRUE),df_all$x.eval + mean(loan_data[loan_data$ne_cutoff==-0.5,]$mpay_value,na.rm=TRUE)))
df_all <- melt(df_all,id=c("x.eval","ne_cutoff"))
df_all$ne_cutoff <- paste(df_all$ne_cutoff*100,"%")
df_all <- df_all[df_all$x.eval>-2.1 & df_all$x.eval<2.1,]
# ggplot(df_all,aes(x=x.eval, y=value,colour=ne_cutoff)) + geom_line(aes(linetype=ne_cutoff), size=1) +scale_linetype_manual(values = c(1,2,3))+scale_colour_manual(values=c("black","gray60","gray30"))+ theme_bw()+ylab("FE adjusted default rate") + xlab("FE adjusted Mortgage-to-value(fit)")+ theme(legend.position="bottom",legend.title=element_blank())

```


```{r graphical_illustration_pe}

# ne_cuts <- c(0.1,0.3,0.5)
# formula_first_stage <- as.formula("mpay_value~mtg30us|factor(zip_year)+factor(org_year)")
# 
# df_all <- NULL
# for(cut in ne_cuts){
#   print(cut)
#   temp <- loan_data_pe[loan_data_pe$ne_cutoff %in% c(cut),]
#   temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))
# 
# 
#   first_stage <- lm(mpay_value~mtg30us+factor(zip_year)+factor(org_year), data=temp)
#   temp['mpay_value_fit'] <- predict(first_stage)*10000
#   temp['std_mpay_value_fit'] <- (temp$mpay_value_fit - mean(temp$mpay_value_fit,na.rm=TRUE))/sd(temp$mpay_value_fit,na.rm = TRUE)
#   temp <- temp[temp$std_mpay_value_fit>-4 & temp$std_mpay_value_fit<4,]
# 
#   # adj_mpay_value <- felm(mpay_value_fit~0|factor(zip_year)+factor(zip_orgyear),data=temp)
#   # temp['resid_mpay_value_fit'] <- adj_mpay_value$residuals*10000
#   adj_default <- felm(def~0|factor(zip_year)+factor(zip_orgyear),data=temp)
#   temp['resid_default'] <- adj_default$residuals
# 
# 
#   bw <- npregbw(formula=as.vector(temp$def)~as.vector(temp$std_mpay_value_fit),bws=0.35,bwtype="fixed",bandwidth.compute=F)
# 
#   model <- npreg(bws=bw,gradients = TRUE)
#   plot.out <- plot(model, plot.errors.method="asymptotic",plot.errors.style="band",plot.behavior="data")
#   y.eval <- fitted(plot.out$r1)
#   x.eval <- plot.out$r1$eval[,1]
#   df <- as.data.frame(cbind(x.eval,y.eval))
#   df['ne_cutoff'] <- cut
#   df_all <- rbind(df_all,df)
# }
# 
# saveRDS(df_all,file="kernal_regs_pe2.rds")

df_all2 <- readRDS(file="kernal_regs_pe2.rds")
# df_all2$y.eval <- ifelse(df_all2$ne_cutoff==0.1,df_all2$y.eval + mean(loan_data_pe[loan_data_pe$ne_cutoff==0.1,]$def,na.rm=TRUE),ifelse(df_all2$ne_cutoff==0.3,df_all2$y.eval + mean(loan_data_pe[loan_data_pe$ne_cutoff==0.3,]$def,na.rm=TRUE),df_all2$y.eval + mean(loan_data_pe[loan_data_pe$ne_cutoff==0.5,]$def,na.rm=TRUE)))
# df_all2$x.eval <- df_all2$x.eval/10000+mean(loan_data[loan_data$ne_cutoff==-0.3,]$mpay_value,na.rm=TRUE)
# df_all$x.eval <- ifelse(df_all$ne_cutoff==-0.1,df_all$x.eval + mean(loan_data[loan_data$ne_cutoff==-0.1,]$mpay_value,na.rm=TRUE),ifelse(df_all$ne_cutoff==-0.3,df_all$x.eval + mean(loan_data[loan_data$ne_cutoff==-0.3,]$mpay_value,na.rm=TRUE),df_all$x.eval + mean(loan_data[loan_data$ne_cutoff==-0.5,]$mpay_value,na.rm=TRUE)))
df_all2 <- melt(df_all2,id=c("x.eval","ne_cutoff"))
df_all2$ne_cutoff <- paste("+",df_all2$ne_cutoff*100,"%")
df_all2 <- df_all2[df_all2$x.eval>-2.1 & df_all2$x.eval<2.1,]
# ggplot(df_all2,aes(x=x.eval, y=value,colour=ne_cutoff)) + geom_line(aes(linetype=ne_cutoff), size=1) +scale_linetype_manual(values = c(1,2,3))+scale_colour_manual(values=c("black","gray60","gray30"))+ theme_bw()+ylab("FE adjusted default rate") + xlab("FE adjusted Mortgage-to-value(fit)")+ theme(legend.position="bottom",legend.title=element_blank())


```

```{r}
df_comb <- rbind(df_all,df_all2)
df_comb$value <- df_comb$value*100
ggplot(df_comb,aes(x=x.eval, y=value,colour=ne_cutoff)) + geom_line(aes(linetype=ne_cutoff),size=0.75) +scale_linetype_manual(values = c(1,5,6,3,2,4))+scale_colour_manual(values=c("black","black","black","gray50","gray50","gray50"))+ theme_bw()+ylab("Default rate (%)") + xlab("Standardized Mortgage-to-value(fit)")+ theme(legend.position="bottom",legend.title=element_blank(),legend.box = "horizontal")
```

# Control Variables
```{r othervariables}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.3),]
temp$zip_orgyear <- paste(temp$zip,temp$org_year)
temp['std_mpay_value'] <- (temp$mpay_value - mean(temp$mpay_value,na.rm=TRUE))/sd(temp$mpay_value,na.rm=TRUE)


temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","current_housevalue","interest_diff","zip_year","zip_orgyear","mtg30us","age_t"))

formula_text <- "~0|factor(zip_year)+factor(zip_orgyear)|(std_mpay_value~mtg30us)|zip_year"

variables <- c("log(ltv)","log(upb)","log(fico)","log(dti)","log(current_housevalue)","interest_diff")
i = 1
felm_regs <- list()
for(variable in variables) {
  # print(i)
  felm_regs[[i]] <- felm(as.formula(paste(variable,formula_text,sep="")),data=temp)
  i=i+1
}

stargazer(felm_regs,type = output.type,no.space = TRUE,column.labels = gsub("_","",variables),notes = note)
```

<a href="#top">Back to top</a>

# RENT

## Rent Regressions

### log(rent) ~ log(home_price)
```{r rent_regression}
setwd(file_path)

# home_price <- read.csv("Zip_MedianSoldPrice_AllHomes.csv")
# home_price <- data.frame(home_price[2], stack(home_price[8:ncol(home_price)]))
# home_price['date']<- as.Date(paste(substr(home_price$ind,2,5),substr(home_price$ind,7,8),"01",sep = "-"))
# home_price$ind <- NULL
# home_price['month'] <- (as.yearmon(home_price$date))
# home_price <- home_price[home_price$date>="2010-01-01",]
# names(home_price) <- c("zip","home_price","date","month")
# # home_price$date <- NULL
# # home_price['zip']<-(home_price$zip %/% 100)
# 
# rent <- read.csv("Zip_MedianRentalPrice_Sfr.csv") 
# rent <- data.frame(rent[1], stack(rent[7:ncol(rent)]))
# rent['date']<- as.Date(paste(substr(rent$ind,2,5),substr(rent$ind,7,8),"01",sep = "-"))
# rent$ind <- NULL
# rent['month'] <- (as.yearmon(rent$date))
# # rent$date <- NULL
# names(rent)<-c("zip","rent","date","month")
# # rent['zip']<-(rent$zip %/% 100)
# 
# 
# rent <- merge(rent, home_price,by=c("zip","date"))
# 
# 
# rent <- rent[complete.cases(rent),]
# # rent <- ddply(rent,.(zip,month),summarise,rent=mean(rent,na.rm = TRUE),hpi=mean(hpi,na.rm = TRUE))
# 
# rent['year'] <- as.numeric(format(rent$date,"%Y"))
# rent$zip <- as.factor(rent$zip)
# rent$year <- as.factor(rent$year)
# 
# rent <- rent[order(rent$zip,rent$date),]
# rent<-slide(rent, Var = "home_price",slideBy = -6,NewVar = "home_price_6")
# rent <- slide(rent, Var = "date",slideBy = -6,NewVar = "date_6")
# rent <- slide(rent, Var = "rent",slideBy = -6,NewVar = "rent_6")
# rent['month_diff'] <- floor(as.numeric(rent$date - rent$date_6)/30)
# rent <- rent[rent$month_diff %in% c(5,6,7),]
# rent$month.x <- NULL
# rent$month.y <- NULL
# rent$month_diff <- NULL
# rent['price_diff'] <- log(rent$home_price/rent$home_price_6)
# rent['rent_diff'] <- log(rent$rent/rent$rent_6)
# 
# temp <- home_price[home_price$date <= '2012-01-01' & home_price$zip %in% unique(rent$zip),]
# temp <- ddply(temp,.(zip),summarise,home_price=mean(home_price,na.rm=TRUE))
# temp['high_value'] <- ifelse(temp$home_price > median(temp$home_price,na.rm = TRUE),1,0)
# temp$home_price <- NULL
# 
# rent <- merge(rent, temp, by="zip",all.x = TRUE)
# 
# saveRDS(rent, file="rent_regression_data.rds")

rent <- readRDS(file="rent_regression_data.rds")

formula_list<- list()
formula_list[[1]] <- as.formula("log(rent)~log(home_price)")
formula_list[[2]] <- as.formula("log(rent)~log(home_price)|factor(year)")
formula_list[[3]] <- as.formula("log(rent)~log(home_price)|factor(year)+factor(zip)")

ols <- list()
ols[[1]] <- felm(formula_list[[1]],rent)
ols[[2]] <- felm(formula_list[[2]],rent)
ols[[3]] <- felm(formula_list[[3]],rent)

stargazer(ols,type = output.type,no.space = TRUE,omit =c("year","zip"),omit.labels = c("year","zip"))

```

### log(rent(t) - rent(t-6)) ~ log(homeprice(t) - homeprice(t-6))
year and zip fixed effects
```{r rent_4}

formula_list[[4]] <- as.formula("rent_diff~price_diff|factor(year)+factor(zip)")

ols <- list()
ols[[1]] <- felm(formula_list[[4]],rent)
ols[[2]] <- felm(formula_list[[4]],rent[rent$price_diff<0,])
ols[[3]] <- felm(formula_list[[4]],rent[rent$price_diff>0,])

stargazer(ols,type = output.type,no.space = TRUE,column.labels = c("All","Price Decreases","Price Increases"))

```

### log(rent) ~ log(home_price) : Split by value
year and zip fixed effects
```{r rent_3}
ols <- list()
ols[[1]] <- felm(formula_list[[3]],rent[rent$high_value==1,])
ols[[2]] <- felm(formula_list[[3]],rent[rent$high_value==0, ])

stargazer(ols,type = output.type,no.space = TRUE,column.labels = c("High Value Houses","Low Value Houses"))
```



## Negative Equity: OLS (mpayvalue*rent)

```{r ols_rent}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.1,-0.2,-0.3,-0.4,-0.5),]
temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))

formula <- as.formula("def~fico+ltv+log(upb)+dti+mpay_value*rent|factor(zip_year)+factor(zip_orgyear)|0|zip_year")


felm_regs <- list()
felm_regs[[1]] <- felm(formula,data=temp[temp$ne_cutoff==-0.1,])
felm_regs[[2]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2,])
felm_regs[[3]] <- felm(formula,data=temp[temp$ne_cutoff==-0.3,])
felm_regs[[4]] <- felm(formula,data=temp[temp$ne_cutoff==-0.4,])
felm_regs[[5]] <- felm(formula,data=temp[temp$ne_cutoff==-0.5,])

printtable(felm_regs,"","default",note,"none","")

```

<a href="#top">Back to top</a>

## Negative Equity: IV Regressions (50-50 Split by rent-to-value)
```{r ne_rent_split_1}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.1,-0.2,-0.3,-0.4,-0.5) ,]
temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))
low <- c(1,2)
high <- c(3,4)

formula <- as.formula("def~fico+ltv+log(upb)+dti|factor(zip_year)+factor(zip_orgyear)|(mpay_value~mtg30us)|zip_year")
felm_regs <- list()
felm_regs[[1]] <- felm(formula,data=temp[temp$ne_cutoff==-0.1 & temp$rent_quartiles %in% low,])
felm_regs[[2]] <- felm(formula,data=temp[temp$ne_cutoff==-0.1 & temp$rent_quartiles %in% high,])
felm_regs[[3]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2 & temp$rent_quartiles %in% low,])
felm_regs[[4]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2 & temp$rent_quartiles %in% high,])
felm_regs[[5]] <- felm(formula,data=temp[temp$ne_cutoff==-0.3 & temp$rent_quartiles %in% low,])
felm_regs[[6]] <- felm(formula,data=temp[temp$ne_cutoff==-0.3 & temp$rent_quartiles %in% high,])
felm_regs[[7]] <- felm(formula,data=temp[temp$ne_cutoff==-0.4 & temp$rent_quartiles %in% low,])
felm_regs[[8]] <- felm(formula,data=temp[temp$ne_cutoff==-0.4 & temp$rent_quartiles %in% high,])
felm_regs[[9]] <- felm(formula,data=temp[temp$ne_cutoff==-0.5 & temp$rent_quartiles %in% low,])
felm_regs[[10]] <- felm(formula,data=temp[temp$ne_cutoff==-0.5 & temp$rent_quartiles %in% high,])

printtable(felm_regs,c("10% low rent","10% high rent","20% low rent","20% high rent","30% low rent","30% high rent","40% low rent","40% high rent","50% low rent","50% high rent"),"default",note,"mtg30us","")

```

## Negative Equity: IV Regressions (75-25 Split by rent-to-value)
```{r ne_rent_split_2}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.1,-0.2,-0.3,-0.4,-0.5) ,]
temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))
low <- c(1,2,3)
high <- c(4)

formula <- as.formula("def~fico+ltv+log(upb)+dti|factor(zip_year)+factor(zip_orgyear)|(mpay_value~mtg30us)|zip_year")
felm_regs <- list()
felm_regs[[1]] <- felm(formula,data=temp[temp$ne_cutoff==-0.1 & temp$rent_quartiles %in% low,])
felm_regs[[2]] <- felm(formula,data=temp[temp$ne_cutoff==-0.1 & temp$rent_quartiles %in% high,])
felm_regs[[3]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2 & temp$rent_quartiles %in% low,])
felm_regs[[4]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2 & temp$rent_quartiles %in% high,])
felm_regs[[5]] <- felm(formula,data=temp[temp$ne_cutoff==-0.3 & temp$rent_quartiles %in% low,])
felm_regs[[6]] <- felm(formula,data=temp[temp$ne_cutoff==-0.3 & temp$rent_quartiles %in% high,])
felm_regs[[7]] <- felm(formula,data=temp[temp$ne_cutoff==-0.4 & temp$rent_quartiles %in% low,])
felm_regs[[8]] <- felm(formula,data=temp[temp$ne_cutoff==-0.4 & temp$rent_quartiles %in% high,])
felm_regs[[9]] <- felm(formula,data=temp[temp$ne_cutoff==-0.5 & temp$rent_quartiles %in% low,])
felm_regs[[10]] <- felm(formula,data=temp[temp$ne_cutoff==-0.5 & temp$rent_quartiles %in% high,])

printtable(felm_regs,c("10% low rent","10% high rent","20% low rent","20% high rent","30% low rent","30% high rent","40% low rent","40% high rent","50% low rent","50% high rent"),"default",note,"mtg30us","")

```

<a href="#top">Back to top</a>




## Foreclosure Delay split
```{r foreclosure_split}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.1,-0.2,-0.3,-0.4,-0.5) ,]
temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))
low <- c(1)
high <- c(2,3,4)

formula <- as.formula("def~fico+ltv+log(upb)+dti|factor(zip_year)+factor(zip_orgyear)|(mpay_value~mtg30us)|zip_year")
felm_regs <- list()
felm_regs[[1]] <- felm(formula,data=temp[temp$ne_cutoff==-0.1 & temp$forc_time_qt %in% low,])
felm_regs[[2]] <- felm(formula,data=temp[temp$ne_cutoff==-0.1 & temp$forc_time_qt %in% high,])
felm_regs[[3]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2 & temp$forc_time_qt %in% low,])
felm_regs[[4]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2 & temp$forc_time_qt %in% high,])
felm_regs[[5]] <- felm(formula,data=temp[temp$ne_cutoff==-0.3 & temp$forc_time_qt %in% low,])
felm_regs[[6]] <- felm(formula,data=temp[temp$ne_cutoff==-0.3 & temp$forc_time_qt %in% high,])
felm_regs[[7]] <- felm(formula,data=temp[temp$ne_cutoff==-0.4 & temp$forc_time_qt %in% low,])
felm_regs[[8]] <- felm(formula,data=temp[temp$ne_cutoff==-0.4 & temp$forc_time_qt %in% high,])
felm_regs[[9]] <- felm(formula,data=temp[temp$ne_cutoff==-0.5 & temp$forc_time_qt %in% low,])
felm_regs[[10]] <- felm(formula,data=temp[temp$ne_cutoff==-0.5 & temp$forc_time_qt %in% high,])

printtable(felm_regs,c("10% low rent","10% high rent","20% low rent","20% high rent","30% low rent","30% high rent","40% low rent","40% high rent","50% low rent","50% high rent"),"default",note,"mtg30us","")
```

# Negative Equity Prepayments

## Negative Equity: Prepayments IV Regressions

```{r prepayment_iv}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.1,-0.2,-0.3,-0.4,-0.5) ,]
temp <- completeFun(temp,c("prepaid","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))

formula <- as.formula("prepaid~fico+ltv+log(upb)+dti|factor(zip_year)+factor(zip_orgyear)|(mpay_value~mtg30us)|zip_year")


felm_regs <- list()
felm_regs[[1]] <- felm(formula,data=temp[temp$ne_cutoff==-0.1,])
felm_regs[[2]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2,])
felm_regs[[3]] <- felm(formula,data=temp[temp$ne_cutoff==-0.3,])
felm_regs[[4]] <- felm(formula,data=temp[temp$ne_cutoff==-0.4,])
felm_regs[[5]] <- felm(formula,data=temp[temp$ne_cutoff==-0.5,])

condf <- c("Cond. F. Stat",round(condfstat(felm_regs[[1]])[[1]],2),round(condfstat(felm_regs[[2]])[[1]],2),round(condfstat(felm_regs[[3]])[[1]],2),round(condfstat(felm_regs[[4]])[[1]],2),round(condfstat(felm_regs[[5]])[[1]],2))

printtable(felm_regs,c("10%","20%","30%","40%","50%"),"prepayment",note,"mtg30us",list(condf))

```


## Negative Equity: Prepayments IV Regressions (Split by rent-to-value)

```{r ne_prepay_rent_split}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.1,-0.2,-0.3,-0.4,-0.5) ,]
temp <- completeFun(temp,c("prepaid","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))
low <- c(1,2)
high <- c(3,4)

formula <- as.formula("prepaid~fico+ltv+log(upb)+dti|factor(zip_year)+factor(zip_orgyear)|(mpay_value~mtg30us)|zip_year")
felm_regs <- list()
felm_regs[[1]] <- felm(formula,data=temp[temp$ne_cutoff==-0.1 & temp$rent_quartiles %in% low,])
felm_regs[[2]] <- felm(formula,data=temp[temp$ne_cutoff==-0.1 & temp$rent_quartiles %in% high,])
felm_regs[[3]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2 & temp$rent_quartiles %in% low,])
felm_regs[[4]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2 & temp$rent_quartiles %in% high,])
felm_regs[[5]] <- felm(formula,data=temp[temp$ne_cutoff==-0.3 & temp$rent_quartiles %in% low,])
felm_regs[[6]] <- felm(formula,data=temp[temp$ne_cutoff==-0.3 & temp$rent_quartiles %in% high,])
felm_regs[[7]] <- felm(formula,data=temp[temp$ne_cutoff==-0.4 & temp$rent_quartiles %in% low,])
felm_regs[[8]] <- felm(formula,data=temp[temp$ne_cutoff==-0.4 & temp$rent_quartiles %in% high,])
felm_regs[[9]] <- felm(formula,data=temp[temp$ne_cutoff==-0.5 & temp$rent_quartiles %in% low,])
felm_regs[[10]] <- felm(formula,data=temp[temp$ne_cutoff==-0.5 & temp$rent_quartiles %in% high,])

printtable(felm_regs,c("10% low rent","10% high rent","20% low rent","20% high rent","30% low rent","30% high rent","40% low rent","40% high rent","50% low rent","50% high rent"),"Prepayment",note,"mtg30us","")

```

<a href="#top">Back to top</a>



## Negative Equity: IV Regressions (Split by origination year)
```{r org_year_split}

temp <- loan_data[loan_data$ne_cutoff %in% c(-0.1,-0.2,-0.3,-0.4,-0.5) ,]
temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))

formula <- as.formula("def~fico+ltv+log(upb)+dti|factor(zip_year)+factor(zip_orgyear)|(mpay_value~mtg30us)|zip_year")
felm_regs <- list()
felm_regs[[1]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2 & temp$org_year<= 2006,])
felm_regs[[2]] <- felm(formula,data=temp[temp$ne_cutoff==-0.2 & temp$org_year> 2006,])

printtable(felm_regs,c("<=2006",">2006"),"default",note,"mtg30us","")
```




# POSITIVE EQUITY

```{r pos_equity_init}
setwd(file_path)

# mtgrates <- read.csv(file="MORTGAGE30US.csv")
# mtgrates$date <- as.Date(mtgrates$date,origin="1900-01-01")
# mtgrates$date <- as.Date(paste(substr(as.character(mtgrates$date),1,7),"-01",sep=""))
# mtgrates <- ddply(mtgrates,.(date),summarise,mtg30us=median(mtg30us,na.rm = TRUE))
# 
# 
# rent <- read.csv("Zip_MedianRentalPrice_Sfr.csv")
# rent <- data.frame(rent[1], stack(rent[7:ncol(rent)]))
# rent$ind <- as.character(rent$ind)
# rent['month']<- as.Date(paste(substr(rent$ind,2,5),substr(rent$ind,7,8),"01",sep = "-"))
# rent$ind <- NULL
# names(rent)<-c("zip","rent","month")
# rent['zip']<-(rent$zip %/% 100)*100
# rent <- rent[rent$month>='2011-01-01' & rent$month<'2012-01-01',]
# rent <- ddply(rent,.(zip),summarise,rent=median(rent,na.rm = TRUE))
# 
# hpi <- read.csv("Zip_Zhvi_SingleFamilyResidence.csv")
# hpi <- data.frame(hpi[2], stack(hpi[8:ncol(hpi)]))
# names(hpi)<-c("zip","value","month")
# hpi$zip <- floor(hpi$zip/100)*100
# hpi$month <- as.Date(paste(substr(hpi$month,2,5),substr(hpi$month,7,8),"01",sep = "-"))
# hpi$value <- as.double(hpi$value)
# hpi <- hpi[hpi$month>='2011-01-01' & hpi$month<'2012-01-01',]
# hpi <- hpi[hpi$zip %in% unique(rent$zip),]
# hpi <- ddply(hpi,.(zip),summarise,value=median(value,na.rm = TRUE))
# 
# rent <- merge(rent,hpi,by="zip")
# rent['rent_value'] <- rent$rent/rent$value
# rent['high_rent'] <- ifelse(rent$rent>median(rent$rent,na.rm = TRUE),1,0)
# rent['high_rent_value'] <- ifelse(rent$rent_value>median(rent$rent_value,na.rm = TRUE),1,0)
# rent <- na.omit(rent)
# rent$rent <- NULL
# rent$value <- NULL
# 
# ###########################################################
# # loan_data
# file_names <- c("cox_ne_0.1_Apr282017_60day.rds","cox_ne_0.3_Apr282017_60day.rds","cox_ne_0.5_Apr282017_60day.rds","cox_ne_0.7_Apr282017_60day.rds")
# #
# loan_data <- NULL
# 
# for(fn in file_names){
#   print(fn)
#   temp <- readRDS(file=fn)
# 
#   temp <- temp[!duplicated(temp[,c("loanid")]),]
# 
#   temp <- merge(temp,mtgrates,by.x=c("orgdate"),by.y = c("date"))
#   temp['mpay_value'] <- temp$mpay/temp$current_housevalue
#   temp['interest_diff'] <- temp$interestrate - temp$mtg30us
#   temp['ne_year'] <- as.numeric(format(as.Date(as.character(temp$current_date)),"%Y"))
#   temp['zip_year'] <- paste(temp$zip,temp$ne_year,sep="_")
#   temp['org_year'] <- as.numeric(format(temp$orgdate,"%Y"))
#   temp['zip_orgyear'] <- paste(temp$zip,temp$org_year,sep="_")
# 
#   if(median(temp$ne_cutoff,na.rm=TRUE)>0 & nrow(temp)>50000) {
#     temp <- temp[temp$org_year<=2010 & temp$ne_year<=2012,]
#     if(nrow(temp)>50000) temp <- temp[sample(nrow(temp),50000),]
#   }
# 
#   temp  <- merge(temp,rent,by=c("zip"),all.x = TRUE)
#   loan_data = rbind(loan_data,temp)
# }
# 
# saveRDS(loan_data,file="loan_data_pos_eqty_Apr262017.rds")

loan_data_pe <- readRDS(file="loan_data_pos_eqty_Apr262017.rds")
```


## Positive Equity: Default IV Regressions
```{r pos_equity_def}
temp <- loan_data_pe[loan_data_pe$ne_cutoff %in% c(0.1,0.3,0.5),]
temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))

formula <- as.formula("def~fico+ltv+log(upb)+dti|factor(zip_year)+factor(zip_orgyear)|(mpay_value~mtg30us)|zip_year")


felm_regs <- list()
felm_regs[[1]] <- felm(formula,data=temp[temp$ne_cutoff==0.1 & is.finite(log(temp$upb)),])
felm_regs[[2]] <- felm(formula,data=temp[temp$ne_cutoff==0.3 & is.finite(log(temp$upb)),])
felm_regs[[3]] <- felm(formula,data=temp[temp$ne_cutoff==0.5 & is.finite(log(temp$upb)),])


condf <- c("Cond. F. Stat",round(condfstat(felm_regs[[1]])[[1]],2),round(condfstat(felm_regs[[2]])[[1]],2),round(condfstat(felm_regs[[3]])[[1]],2))#,round(condfstat(felm_regs[[4]])[[1]],2),round(condfstat(felm_regs[[5]])[[1]],2))

printtable(felm_regs,c("10","30","50"),"default",note,"mtg30us",list(condf))
```

<a href="#top">Back to top</a>

## Positive Equity: Prepayment IV Regressions
```{r pos_eqt_prepay}
temp <- loan_data_pe[loan_data_pe$ne_cutoff %in% c(0.1,0.3,0.5),]
temp <- completeFun(temp,c("prepaid","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))

formula <- as.formula("prepaid~fico+ltv+log(upb)+dti|factor(zip_year)+factor(zip_orgyear)|(mpay_value~mtg30us)|zip_year")


felm_regs <- list()
felm_regs[[1]] <- felm(formula,data=temp[temp$ne_cutoff==0.1 & is.finite(log(temp$upb)),])
felm_regs[[2]] <- felm(formula,data=temp[temp$ne_cutoff==0.3 & is.finite(log(temp$upb)),])
felm_regs[[3]] <- felm(formula,data=temp[temp$ne_cutoff==0.5 & is.finite(log(temp$upb)),])

condf <- c("Cond. F. Stat",round(condfstat(felm_regs[[1]])[[1]],2),round(condfstat(felm_regs[[2]])[[1]],2),round(condfstat(felm_regs[[3]])[[1]],2))#,round(condfstat(felm_regs[[4]])[[1]],2),round(condfstat(felm_regs[[5]])[[1]],2))
printtable(felm_regs,c("10","30","50"),"Prepaid",note,"mtg30us",list(condf))
```

<a href="#top">Back to top</a>

## Positive Equity Prepayments Rent Split
```{r pos_equity_rent_split}
temp <- loan_data_pe[loan_data_pe$ne_cutoff %in% c(0.1,0.3,0.5) ,]
temp <- completeFun(temp,c("prepaid","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))

formula <- as.formula("prepaid~fico+ltv+log(upb)+dti|factor(zip_year)+factor(zip_orgyear)|(mpay_value~mtg30us)|zip_year")
felm_regs <- list()
felm_regs[[1]] <- felm(formula,data=temp[temp$ne_cutoff==0.1 & temp$high_rent_value==0,])
felm_regs[[2]] <- felm(formula,data=temp[temp$ne_cutoff==0.1 & temp$high_rent_value==1,])
felm_regs[[3]] <- felm(formula,data=temp[temp$ne_cutoff==0.3 & temp$high_rent_value==0,])
felm_regs[[4]] <- felm(formula,data=temp[temp$ne_cutoff==0.3 & temp$high_rent_value==1,])
felm_regs[[5]] <- felm(formula,data=temp[temp$ne_cutoff==0.5 & temp$high_rent_value==0,])
felm_regs[[6]] <- felm(formula,data=temp[temp$ne_cutoff==0.5 & temp$high_rent_value==1,])

printtable(felm_regs,c("10 low rent","10 high rent","30 low rent","30 high rent","50 low rent","50 high rent"),"Prepayment",note,"mtg30us","")

```



# Other Splits

## First stage by year (NE 30%)

```{r first_stage_by_year}

temp <- loan_data[loan_data$ne_cutoff %in% c(-0.3),]
temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","zip_year","zip_orgyear","mtg30us"))
temp$mpay_value  = temp$mpay_value * 100000
formula <- as.formula("mpay_value~mtg30us+fico+ltv+log(upb)+dti|factor(zip_year)+factor(org_year)|0|zip_year")

iv_reg_1st <- list()
iv_reg_1st[[1]] <- felm(formula, data=temp[temp$org_year<=2006,])
iv_reg_1st[[2]] <- felm(formula, data=temp[temp$org_year >=2007,])


printtable(iv_reg_1st,c("<=2006",">=2007"),"mpay value",note,"none","")
```

## Control Variables <=2006

```{r othervariables_lt2006}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.3) & loan_data$org_year<=2006,]
temp$zip_orgyear <- paste(temp$zip,temp$org_year)
temp['std_mpay_value'] <- (temp$mpay_value - mean(temp$mpay_value,na.rm=TRUE))/sd(temp$mpay_value,na.rm=TRUE)


temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","current_housevalue","interest_diff","zip_year","zip_orgyear","mtg30us","age_t"))

formula_text <- "~0|factor(zip_year)+factor(zip_orgyear)|(std_mpay_value~mtg30us)|zip_year"

variables <- c("log(ltv)","log(upb)","log(fico)","log(dti)","log(current_housevalue)","interest_diff")
i = 1
felm_regs <- list()
for(variable in variables) {
  # print(i)
  felm_regs[[i]] <- felm(as.formula(paste(variable,formula_text,sep="")),data=temp)
  i=i+1
}

stargazer(felm_regs,type = output.type,no.space = TRUE,column.labels = gsub("_","",variables),notes = note)
```

## Control Variables >=2007

```{r othervariables_gt2007}
temp <- loan_data[loan_data$ne_cutoff %in% c(-0.3) & loan_data$org_year>=2007,]
temp$zip_orgyear <- paste(temp$zip,temp$org_year)
temp['std_mpay_value'] <- (temp$mpay_value - mean(temp$mpay_value,na.rm=TRUE))/sd(temp$mpay_value,na.rm=TRUE)


temp <- completeFun(temp,c("def","mpay_value","fico","ltv","dti","upb","current_housevalue","interest_diff","zip_year","zip_orgyear","mtg30us","age_t"))

formula_text <- "~0|factor(zip_year)+factor(zip_orgyear)|(std_mpay_value~mtg30us)|zip_year"

variables <- c("log(ltv)","log(upb)","log(fico)","log(dti)","log(current_housevalue)","interest_diff")
i = 1
felm_regs <- list()
for(variable in variables) {
  # print(i)
  felm_regs[[i]] <- felm(as.formula(paste(variable,formula_text,sep="")),data=temp)
  i=i+1
}

stargazer(felm_regs,type = output.type,no.space = TRUE,column.labels = gsub("_","",variables),notes = note)
```