---
title: "Cost of Alternative Housing Option and Strategic Default: Results"
author: "DC & DR"
date: "December 09, 2016"
output: 
  html_document: 
    css: bodycss.css
    fig_height: 6
    fig_width: 12
    toc: yes
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r echo=FALSE}
rm(list=ls())
library(data.table)
library(zoo)
library(sqldf)
library(stargazer)
library(survival)
library(reshape2)
library(zipcode)
library(ggplot2)
library(multiwayvcov)
library(sandwich)
library(Matching)
library(AER)
file_path = "E:/strategic_default/"
setwd(file_path)
source("functions.R")
output.type = "text"

#         zillow_cox <- readRDS("cox_ne_-0.1_Dec082016.rds")
#         temp <- zillow_cox
#         temp['temp']<- (temp$current_housevalue-temp$currentupb_t)/temp$current_housevalue
#         temp['temp']<- temp$temp - temp$current_equity
#         temp = temp[abs(temp$temp)<0.001,]
#         temp <- temp[!is.na(temp$adjusted_mpay_rent),]
#         temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
#         zillow_cox = temp
#         
#         temp <- readRDS("cox_ne_-0.2_Dec082016.rds")
#         temp['temp']<- (temp$current_housevalue-temp$currentupb_t)/temp$current_housevalue
#         temp['temp']<- temp$temp - temp$current_equity
#         temp = temp[abs(temp$temp)<0.001,]
#         temp <- temp[!is.na(temp$adjusted_mpay_rent),]
#         temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
#         zillow_cox = rbind(zillow_cox,temp)
#         
#         temp <- readRDS("cox_ne_-0.01_Dec082016.rds")
#         temp['temp']<- (temp$current_housevalue-temp$currentupb_t)/temp$current_housevalue
#         temp['temp']<- temp$temp - temp$current_equity
#         temp = temp[abs(temp$temp)<0.001,]
#         temp <- temp[!is.na(temp$adjusted_mpay_rent),]
#         temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
#         zillow_cox = rbind(zillow_cox,temp)
#         
#         temp <- readRDS("cox_ne_-0.5_Dec082016.rds")
#         temp['temp']<- (temp$current_housevalue-temp$currentupb_t)/temp$current_housevalue
#         temp['temp']<- temp$temp - temp$current_equity
#         temp = temp[abs(temp$temp)<0.001,]
#         temp <- temp[!is.na(temp$adjusted_mpay_rent),]
#         temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
#         zillow_cox = rbind(zillow_cox,temp)
#         
#         zip_forc_time <- readRDS("zip_forc_time.rds")
#         zillow_cox <- merge(zillow_cox,zip_forc_time,by="zip",all.x = TRUE)
#         zillow_cox <- zillow_cox[zillow_cox$interestrate==zillow_cox$interestrate_t,]
#         mpay_table <- readRDS("mpay_table.rds")
#         #zillow_cox['mpay_rent_ins']<-zillow_cox$mpay/zillow_cox$rent_pct
#         
#         zillow_cox['rent_diff'] <- zillow_cox$rent-zillow_cox$medgrossrent
#         
#         zillow_cox['ne_year'] <- zillow_cox$ne_qt %/% 1
#         
#         forc_numbers <- read.csv("forc_df.csv",sep = "|")
#         default_numbers <- read.csv("def1_df.csv",sep="|")
#         loan_numbers <- read.csv("loan_df.csv",sep="|")
#         mortgage_data <- merge(loan_numbers,default_numbers,by=c("month","zip"),all.x = TRUE)
#         mortgage_data <- merge(mortgage_data,forc_numbers,by=c("month","zip"),all.x = TRUE)
#         mortgage_data['forc_pct'] <- mortgage_data$forc_numbers/mortgage_data$loan_numbers
#         mortgage_data['default_pct'] <- mortgage_data$def1_numbers/mortgage_data$loan_numbers
#         mortgage_data$month <- as.Date(as.character(mortgage_data$month))
#         mortgage_data['year']<- as.numeric(format(mortgage_data$month,"%Y"))
#         mortgage_data <- mortgage_data[mortgage_data$year
#                                        >2007 & mortgage_data$year<2010,]
#         mortgage_data <- ddply(mortgage_data,.(zip),summarise,forc_pct = mean(forc_pct,na.rm = TRUE),default_pct = mean(default_pct,na.rm = TRUE))
#         
#         hpi <- read.csv("HPI3zip.csv")
#         hpi$zip <- hpi$zip/10
#         hpi['current_q']<- as.yearqtr(as.Date(hpi$yearquarter,origin="1900-01-01"))
#         hpi <- ddply(hpi,.(zip,current_q),summarise,index=mean(index,na.rm = TRUE))
#         hpi_1 <- hpi[hpi$current_q == 2009,]
#         hpi_1$current_q <- NULL
#         names(hpi_1) <- c("zip","index_2009")
#         hpi_2 <- hpi[hpi$current_q == 2011,]
#         hpi_2$current_q <-NULL
#         names(hpi_2) <- c("zip","index_2011")
#         hpi <- merge(hpi_1,hpi_2,by=c("zip"))
#         hpi['hpi_change'] <- log(hpi$index_2011/hpi$index_2009)
#         hpi$index_2009<-NULL
#         hpi$index_2011<-NULL
#         
#         zillow_cox <- merge(zillow_cox,mortgage_data,by=c("zip"),all.x = TRUE)
#         zillow_cox <- merge(zillow_cox,hpi,by=c("zip"),all.x = TRUE)
#         zillow_cox['mpay_rent'] <- zillow_cox$mpay/zillow_cox$rent
#         
#         
#         
#         agent_data <- readRDS("agents_11_2016.rds")
#         agent_data$zip <- (agent_data$zip %/% 100) *100
#         agent_data <- ddply(agent_data,.(zip),summarise,agents=mean(agents,na.rm = TRUE))
#         
#         
#         zillow_cox <- merge(zillow_cox,agent_data,by="zip",all.x = TRUE)
#         
#         property_tax <- readRDS("prop_tax.rds")
#         
#         zillow_cox <- merge(zillow_cox,property_tax,by="zip",all.x = TRUE)
#         zillow_cox['prop_tax_value'] <- (zillow_cox$current_housevalue*zillow_cox$prop_tax_pct)/12
#         zillow_cox$mpay <- zillow_cox$mpay+zillow_cox$prop_tax_value*0.9+zillow_cox$upb*(100/zillow_cox$ltv)*0.01/12
#         zillow_cox$adjusted_mpay_rent <- zillow_cox$mpay/zillow_cox$adjusted_rent
#         
#         sch_ratings <- readRDS("sch_rating.rds")
#         
#         zillow_cox <- merge(zillow_cox,sch_ratings,by="zip",all.x = TRUE)
#         
# 
#         zillow_cox['org_year'] <- as.integer(format(as.Date(as.character(zillow_cox$orgdate)),"%Y"))
#         zillow_cox['org_qt'] <- as.yearqtr(as.Date(as.character(zillow_cox$orgdate)))
#         interestrate_zip <- readRDS("interestrate_zip.rds")
#         zillow_cox <- merge(zillow_cox,interestrate_zip,by=c("zip","org_qt"),all.x = TRUE)
#         zillow_cox['interest_diff'] <- (zillow_cox$interestrate - zillow_cox$interestrate_avg)/zillow_cox$interestrate_avg
#         
#         saveRDS(zillow_cox,file="zillow_cox_dec9.rds")

zillow_cox <- readRDS(file="zillow_cox_dec9.rds")
```

### Default %
```{r defpct}
setwd(file_path)
# default_pct <- ddply(zillow_cox,.(ne_cutoff),summarise,default_rate = mean(def,na.rm = TRUE),obs=length(loanid))
# default_pct <- default_pct[order(-default_pct$ne_cutoff),]
# stargazer(default_pct,summary = FALSE,type = output.type)


# Positive Equity

pos_eqty <- readRDS("cox_ne_0.1_Dec082016.rds")
pos_eqty <- pos_eqty[,c("loanid","ne_cutoff","def")]
pos_eqty <- pos_eqty[!duplicated(pos_eqty[,c("loanid","ne_cutoff")]),]
temp  <- readRDS("cox_ne_0.2_Dec082016.rds")
temp <- temp[,c("loanid","ne_cutoff","def")]
temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
pos_eqty <- rbind(pos_eqty,temp)
temp  <- readRDS("cox_ne_0.5_Dec082016.rds")
temp <- temp[,c("loanid","ne_cutoff","def")]
temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
pos_eqty <- rbind(pos_eqty,temp)
temp <- zillow_cox[,c("loanid","ne_cutoff","def")]
pos_eqty <- rbind(pos_eqty,temp)

gc( verbose = FALSE)
default_pct <- ddply(pos_eqty,.(ne_cutoff),summarise,default_rate = mean(def,na.rm = TRUE),obs=length(loanid))
default_pct <- default_pct[order(-default_pct$ne_cutoff),]
stargazer(default_pct,summary = FALSE,type = output.type)
rm(pos_eqty)
gc( verbose = FALSE)
```


### Illustration
Parameters: time 7 years;; loan age = 5 years; loan amount = 240,000; interest rate = 6%; default cost = 5000; foreclosure delay = 12 months; house price mu = 3%; house price sd 5%; Power utility with risk aversion = 2
```{r illustration,echo=FALSE}
library(FinCal)
library(ggplot2)
library(reshape2)
library(scales)
library(pracma)


pi = 3.141592654

loan_age = 5
loan_amount = 240000

time_years = 7

houseprice_mu = .03*time_years
houseprice_sigma = .05*sqrt(time_years)

ra = 2

utility <- function(x){
  return((x^(1-ra)-1)/(1-ra))
}

prob_deficiency_judgment = 0


#interest rate
ir = .06
#other costs of default
cost = 5000

#time_years year discount rate
d = 1/((1+ir)^time_years)

forc_delay = 12

#forc_delay year discount rate
d_fd = 1/((1+ir)^forc_delay)

#present value of balance in time_years years
mortgage_end = amortize(p_input = loan_amount,i_input = ir)[12*(loan_age+time_years),1]
mortgage_forc_delay = amortize(p_input = loan_amount,i_input = ir)[12*(loan_age+forc_delay),1]
PV_mortgage_end = amortize(p_input = loan_amount,i_input = ir)[12*(loan_age+time_years),1]*d


#wealth
W = 500000

rent = 1500

#mortgage payment
mpay = amortize(p_input = loan_amount,i_input = ir)[1,2]

# abs(negative equity)
ne=0

calc_utility <- function(ne=0.2,forc_delay=12,rent=1500,cost=5000)  {

  PV_free_rent = pv(r=ir/12,pmt=-rent,n=forc_delay)

  House_Value = (1-ne)*amortize(p_input = loan_amount,i_input = ir)[12*loan_age,1]
  PV_mpay = pv(r=ir/12,pmt=-mpay,n = time_years*12)
  PV_rent = pv(r=ir/12,pmt=-rent,n=time_years*12)-PV_free_rent
  
  # when the house price appriciation is less than xstar, borrower defaults at the end. otherwise sells the house
  xstar = (mortgage_end+cost)/(House_Value)-1
  
  
  
  # expected utility from defaulting at the end (x is house price appriciation rate)
  integrand1 <- function(x) {
    stay_shortfall <- max((mortgage_end-(1+x)*House_Value)*d,0)
    (1/sqrt(2*pi*houseprice_sigma^2))*exp(-((x-houseprice_mu)^2)/(2*houseprice_sigma^2)) * utility(W-PV_mpay-cost - prob_deficiency_judgment*stay_shortfall)
  }
  
  # expected utility from selling at the end (x is house price appriciation rate)
  integrand2 <- function(x) {
    (1/sqrt(2*pi*houseprice_sigma^2))*exp(-((x-houseprice_mu)^2)/(2*houseprice_sigma^2)) * utility(W-PV_mortgage_end-PV_mpay+d*(1+x)*House_Value)
  }
  
  
  Utility_stay = integral(integrand1, -Inf, xstar,method = 'Kronrod', reltol = 1e-8)[1] + integral(integrand2, xstar, Inf,method = 'Kronrod', reltol = 1e-8)[1]
  
  default_shortfall <- max((mortgage_forc_delay-House_Value*(1+houseprice_mu*(forc_delay/12)/time_years)),0)
  Utility_default = utility(W-cost-PV_rent-prob_deficiency_judgment*(default_shortfall+PV_free_rent))
  
  return(c(Utility_stay,Utility_default))

}

ne_vector = seq(0,0.7,0.01)
utility_vector <- NULL
for(ne in ne_vector)  {
  utility_vector <- rbind(utility_vector,c(ne,calc_utility(ne=ne)))
}
utility_vector <- as.data.frame(utility_vector)
names(utility_vector) <- c("x","Utility_stay","Utility_default")
utility_vector <- melt(utility_vector, id="x")
names(utility_vector)[3]<-"utility"
utility_vector$utility <- utility_vector$utility*100000-99999

y_min <- min(utility_vector$utility)*0.99
y_max <- max(utility_vector$utility)

p1 <- ggplot(data=utility_vector,aes(x=x, y=utility, colour=variable)) +  geom_line(aes(linetype=variable), size=2)+ scale_color_manual(name="",values=c("gray20", "gray60"),labels = c(expression(U[stay]), expression(U[default])))+
  xlab("Negative Equity") + ylab("Utility")+ylim(y_min,y_max) +scale_linetype_manual(name="",labels = c(expression(U[stay]), expression(U[default])),values=c(1,2))+scale_shape_discrete(name="", labels = c(expression(U[stay]), expression(U[default])))+ theme_bw(base_size = 18)+theme(legend.position="bottom",legend.direction="horizontal",legend.title=element_blank(),
        axis.text.y=element_blank(),axis.ticks.y=element_blank(),legend.key.width=unit(5,"line"),legend.key = element_blank())#+ labs(title = "Non-Recourse")

ne = 0.2

p1


ne_vector = seq(0,0.7,0.01)
utility_vector <- NULL
for(ne in ne_vector)  {
  utility_vector <- rbind(utility_vector,c(ne,calc_utility(ne=ne),calc_utility(ne=ne,rent = 1700)))
}
utility_vector <- as.data.frame(utility_vector)
names(utility_vector) <- c("x","Utility_stay","Utility_default","Utility_stay_1700","Utility_default_1700")
utility_vector$Utility_stay_1700 <- NULL
utility_vector <- melt(utility_vector, id="x")
names(utility_vector)[3]<-"utility"
utility_vector$utility <- utility_vector$utility*100000-99999

rect <- data.frame(xmin=0.255, xmax=0.36, ymin=-Inf, ymax=Inf)


p1_1 <- ggplot(data=utility_vector,aes(x=x, y=utility, colour=variable)) +  geom_line(aes(linetype=variable), size=2)+ scale_color_manual(name="",values=c("gray20", "gray40","gray60"),labels = c(expression(U[stay]), expression(U[default](rent:1500)),expression(U[default](rent:1700))))+
  xlab("Negative Equity") + ylab("Utility")+ylim(y_min,y_max) +scale_linetype_manual(name="",labels = c(expression(U[stay]), expression(U[default](rent:1500)),expression(U[default](rent:1700))),values=c(1,2,2))+scale_shape_discrete(name="", labels = c(expression(U[stay]), expression(U[default](rent:1500)),expression(U[default](rent:1700))))+ theme_bw(base_size = 18)+theme(legend.position="bottom",legend.direction="horizontal",legend.title=element_blank(),
        axis.text.y=element_blank(),axis.ticks.y=element_blank(),legend.key.width=unit(5,"line"),legend.key = element_blank())+geom_rect(data=rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),fill="gray80",alpha=0.3,
              inherit.aes = FALSE)

ne = 0.2

p1_1
```

### Descriptive Statistics: Negative Equity Loans
```{r desc}

stargazer(
  zillow_cox[zillow_cox$ne_cutoff==-0.010, c("upb","fico","ltv","interest_diff","interestrate_avg","adjusted_mpay_rent","mpay","org_year","median_forc_time")], type = output.type, 
  summary.stat = c("mean", "sd", "p25", "median", "p75", "n")
)

```

### Descriptive Statistics: All loans (orginated between 2006 and 2008 and in same zipcodes)
```{r descallloans}
setwd(file_path)
allloans <- readRDS("freddie_orgination_data_upto_Q32015.rds")
allloans <- allloans[allloans$zip %in% unique(zillow_cox$zip),]
allloans['org_year'] <- as.integer(format(as.Date(as.character(allloans$orgdate)),"%Y"))
allloans <- allloans[allloans$org_year >= 2006 & allloans$org_year <= 2008,]

allloans['org_qt'] <- as.yearqtr(as.Date(as.character(allloans$orgdate)))
interestrate_zip <- readRDS("interestrate_zip.rds")
allloans <- merge(allloans,interestrate_zip,by=c("zip","org_qt"),all.x = TRUE)
allloans['interest_diff'] <- (allloans$interestrate - allloans$interestrate_avg)/allloans$interestrate_avg

stargazer(
  allloans[, c("upb","fico","ltv","interest_diff","interestrate_avg")], type = output.type, 
  summary.stat = c("mean", "sd", "p25", "median", "p75", "n")
)

rm(allloans)
gc( verbose = FALSE)
```

### Correlation
```{r corr}

cor_table <-cor(zillow_cox[zillow_cox$ne_cutoff==-0.01,c("adjusted_mpay_rent","fico","ltv","interest_diff","interestrate_avg","upb","org_hpi")],use = "complete.obs")

stargazer(cor_table,type=output.type,summary = FALSE)
```

### mpay/rent histogram
```{r }
ggplot(data=zillow_cox[zillow_cox$ne_cutoff==-0.01,], aes(zillow_cox[zillow_cox$ne_cutoff==-0.01,]$adjusted_mpay_rent)) + 
  geom_histogram(breaks=seq(0.6,2, by=0.1),col="black")+ylab("Number of Loans")+xlab("mpay/rent") + theme_bw(base_size = 18)
```

### mpay/rent maps
```{r include=FALSE}
# require(RCurl)
# require(zipcode)
# require(ggmap)
# require(ggplot2)
# 
# zip_mpay_rent <- readRDS("zip_mpay_rent.rds")
# 
# 
# head(zip_mpay_rent)
# 
# data(zipcode)
# names(zipcode)[1] = "zip5"
# zipcode$zip5 <- as.numeric(zipcode$zip5)
# zipcode['zip']<-floor(zipcode$zip5/100)*100
# zip_mpay_rent <- merge(zipcode, zip_mpay_rent, by='zip')
# zip_mpay_rent['ind']<- 1
# 
# 
# map<-get_map(location='united states', zoom=4, maptype = "terrain",
#              source='google',color='bw',crop = TRUE)
# 
# ggmap(map) + geom_point(
#   aes(x=longitude, y=latitude, show_guide = FALSE, colour=ind), 
#   data=zip_mpay_rent, alpha=.8, na.rm = T)+guides(colour=FALSE)+scale_color_gradient(low="gray24", high="gray24")   
# 
# 
# map<-get_map(location='united states', zoom=4, maptype = "terrain",
#              source='google',color='bw',crop = TRUE)
# 
# ggmap(map) + geom_point(
#   aes(x=longitude, y=latitude, show_guide = TRUE, colour=mpay_rent), 
#   data=zip_mpay_rent, alpha=.99, na.rm = T)  + 
#   scale_color_gradient(low="gray70", high="black")
```
![](E:\strategic_default\map1.png)<br/>
![](E:\strategic_default\map2.png)

### Rent Regression using house level data
```{r rentreg}
setwd(file_path)
rentdata <- readRDS("zillow_houselevel_rentdata.rds")

ols <- list()
se <- list()
ols[[1]] <- lm(log(rent)~log(zest_value)+factor(state),data = rentdata)
  se[[1]] <-sqrt(diag(cluster.vcov(ols[[1]], cbind(rentdata$state))))
ols[[2]] <- lm(log(rent)~log(zest_value)+beds+baths+sqft+avg_school_rating+prop_tax_pct+forc_pct+hpi_change+factor(state),data = rentdata)
  se[[2]] <-sqrt(diag(cluster.vcov(ols[[2]], cbind(rentdata$state))))
ols[[3]] <- lm(log(rent)~beds+baths+sqft+log(zest_value)+avg_school_rating+prop_tax_pct+forc_pct+hpi_change+Lot+I(2016-Builtin)+future_price_appr+factor(state),data = rentdata)
  se[[3]] <-sqrt(diag(cluster.vcov(ols[[3]], cbind(rentdata$state))))
ols[[4]] <- lm(mpay_rent~beds+baths+sqft+log(zest_value)+avg_school_rating+prop_tax_pct+forc_pct+hpi_change+Lot+I(2016-Builtin)+future_price_appr+factor(state),data = rentdata)
  se[[4]] <-sqrt(diag(cluster.vcov(ols[[4]], cbind(rentdata$state))))
  
stargazer(ols,type = output.type,no.space = TRUE,omit=c("state"),omit.labels = c("state"),se=se,notes = "Standard Errors clustered by state",title = "House Level",omit.stat = c("f","ser"))

```

### Rent Prediction 
```{r  rentprediction}
ols <- lm(log(rent)~log(zest_value)+I(log(zest_value)^2)+I(log(zest_value)^3)+I(log(zest_value)^4)+I(log(zest_value)^5)+factor(state),data = rentdata)


zillow_cox['zest_value'] <- zillow_cox$current_housevalue
zillow_cox['rent_hat'] <- predict(ols,zillow_cox)
zillow_cox['mpay_rent_hat']<-zillow_cox$mpay/(zillow_cox$rent_hat)

summary(ols)$r.sq


```

### Main model : Cox PH
```{r main}
cox_formula<-list()

cox_formula[[1]] <- as.formula("Surv(duration,def)~adjusted_mpay_rent+median_forc_time+interestrate+age_t+age_t*age_t+factor(ne_year)+fico+ltv+dti+avg_school_rating+medhhincome+medhouseage+vacantpct+bachelorpct+withsalarypct+factor(occupancy)+factor(purpose)+factor(state)+factor(ne_cutoff)+log(upb)/ltv+mpay/dti+default_pct+hpi_change+forc_pct")



cox <-list()
cox[[1]] <- coxph(cox_formula[[1]],data = zillow_cox,control = coxph.control(iter.max = 1000))
cox[[2]] <- coxph(cox_formula[[1]],data = zillow_cox[zillow_cox$adjusted_mpay_rent<1,],control = coxph.control(iter.max = 1000))
cox[[3]] <- coxph(cox_formula[[1]],data = zillow_cox[zillow_cox$adjusted_mpay_rent>=1,],control = coxph.control(iter.max = 1000))

stargazer(cox,type = output.type,no.space = TRUE,omit = c("state","ne_year","ne_cutoff","occupancy","purpose"),omit.labels =  c("state","ne year","ne cutoff","occupancy","purpose"),column.labels = c("All","mpayrent < 1","mpayrent > 1"),omit.stat = c("ll","logrank","max.rsq","lr","wald"))

cox <- NULL
gc( verbose = FALSE)
```

### Main model : Logit
```{r mainlogit}
logit_formula<-list()

logit_formula[[1]] <- as.formula("def~adjusted_mpay_rent+median_forc_time+interestrate+age_t+age_t*age_t+factor(ne_year)+fico+ltv+dti+avg_school_rating+medhhincome+medhouseage+vacantpct+bachelorpct+withsalarypct+factor(occupancy)+factor(purpose)+factor(state)+factor(ne_cutoff)+log(upb)/ltv+mpay/dti+default_pct+hpi_change+forc_pct")



logit <-list()
logit[[1]] <- glm(logit_formula[[1]],data = zillow_cox,family=binomial(link='logit'))
logit[[2]] <- glm(logit_formula[[1]],family=binomial(link='logit'),data = zillow_cox[zillow_cox$adjusted_mpay_rent<1,])
logit[[3]] <- glm(logit_formula[[1]],family=binomial(link='logit'),data = zillow_cox[zillow_cox$adjusted_mpay_rent>=1,])

stargazer(logit,type = output.type,no.space = TRUE,omit = c("state","ne_year","ne_cutoff","occupancy","purpose"),omit.labels =  c("state","ne year","ne cutoff","occupancy","purpose"),column.labels = c("All","mpayrent < 1","mpayrent > 1"),omit.stat = c("ll","logrank","max.rsq","lr","wald"))

logit <- NULL
gc( verbose = FALSE)
```

### Alternative Measures: Cox PH
```{r altmeasures}

cox_formula[[2]] <- as.formula("Surv(duration,def)~rent_pct+median_forc_time+interestrate+age_t+age_t*age_t+factor(ne_year)+fico+ltv+dti+avg_school_rating+medhhincome+medhouseage+vacantpct+bachelorpct+withsalarypct+factor(occupancy)+factor(purpose)+factor(state)+factor(ne_cutoff)+log(upb)/ltv+mpay/dti+default_pct+hpi_change+forc_pct")

cox_formula[[3]] <- as.formula("Surv(duration,def)~log(rent_diff)+median_forc_time+interestrate+age_t+age_t*age_t+factor(ne_year)+fico+ltv+dti+avg_school_rating+medhhincome+medhouseage+vacantpct+bachelorpct+withsalarypct+factor(occupancy)+factor(purpose)+factor(state)+factor(ne_cutoff)+log(upb)/ltv+mpay/dti+default_pct+hpi_change+forc_pct")

cox_formula[[4]] <- as.formula("Surv(duration,def)~agents+median_forc_time+interestrate+age_t+age_t*age_t+factor(ne_year)+fico+ltv+dti+avg_school_rating+medhhincome+medhouseage+vacantpct+bachelorpct+withsalarypct+factor(occupancy)+factor(purpose)+factor(state)+factor(ne_cutoff)+log(upb)/ltv+mpay/dti+default_pct+hpi_change+forc_pct")

cox_formula[[5]] <- as.formula("Surv(duration,def)~mpay_rent_hat+median_forc_time+interestrate+age_t+age_t*age_t+factor(ne_year)+fico+ltv+dti+avg_school_rating+medhhincome+medhouseage+vacantpct+bachelorpct+withsalarypct+factor(occupancy)+factor(purpose)+factor(state)+factor(ne_cutoff)+log(upb)/ltv+mpay/dti+default_pct+hpi_change+forc_pct")

cox <-list()
cox[[1]] <- coxph(cox_formula[[2]],data = zillow_cox,control = coxph.control(iter.max = 1000))
#cox[[5]] <- coxph(cox_formula[[3]],data = zillow_cox,control = coxph.control(iter.max = 1000))
cox[[2]] <- coxph(cox_formula[[4]],data = zillow_cox,control = coxph.control(iter.max = 1000))
cox[[3]] <- coxph(cox_formula[[5]],data = zillow_cox,control = coxph.control(iter.max = 1000))
stargazer(cox,type = output.type,no.space = TRUE,omit = c("state","ne_year","ne_cutoff","occupancy","purpose"),omit.labels =  c("state","ne year","ne cutoff","occupancy","purpose"),omit.stat = c("ll","logrank","max.rsq","lr","wald"))

cox <- NULL
gc( verbose = FALSE)
```

### LPM Model with standard errors clustered by zip code and time
```{r lpm}
library(multiwayvcov)
library(sandwich)


lpm_formula <- list()
lpm_formula[[1]] <- as.formula("def~adjusted_mpay_rent+median_forc_time+interestrate+age_t+fico+ltv+dti+medhhincome+medhouseage+vacantpct+bachelorpct+withsalarypct+factor(occupancy)+factor(purpose)+factor(ne_cutoff)+default_pct+hpi_change+forc_pct+factor(zip)+factor(ne_year)+upb")

lpm <- list()
se <- list()
lpm[[1]] <- lm(lpm_formula[[1]],data=zillow_cox)
se[[1]] <-sqrt(diag(cluster.vcov(lpm[[1]], cbind(zillow_cox$zip,zillow_cox$ne_year))))

stargazer(lpm,type=output.type,no.space=TRUE,omit=c("zip","ne_year","purpose","occupancy","ne_cutoff"))
```

### LPM Prediction for 10% negative equity sample
Using only statistically significant variables
```{r lpmprediction}
lpm_sum <- summary(lm(def~adjusted_mpay_rent+median_forc_time+interestrate+age_t+fico+ltv+dti+factor(zip)+factor(ne_year)+upb,data = zillow_cox[zillow_cox$ne_cutoff== - 0.1,]))
lpm_coef <- as.data.frame(lpm_sum$coefficients)
lpm_coef['x']<- row.names(lpm_coef)
lpm_coef$`Std. Error` <-NULL
lpm_coef$`Pr(>|t|)` <- NULL
lpm_coef$`t value` <- NULL

factor_zip <- mean(lpm_coef[substr(lpm_coef$x,1,11)=="factor(zip)",]$Estimate)
lpm_coef <- lpm_coef[substr(lpm_coef$x,1,11)!="factor(zip)",]
factor_ne_year<- mean(lpm_coef[substr(lpm_coef$x,1,15)=="factor(ne_year)",]$Estimate)
lpm_coef <- lpm_coef[substr(lpm_coef$x,1,15)!="factor(ne_year)",]

lpm_coef <- lpm_coef[!lpm_coef$x %in% c("factor(ne_cutoff)-0.01","factor(ne_cutoff)-0.2","factor(occupancy)S","factor(purpose)N","factor(purpose)P"),]

lpm_coef['value'] <- NA
lpm_coef[lpm_coef$x=="(Intercept)",'value']=0
lpm_coef[lpm_coef$x=="median_forc_time",'value'] = 0 #mean(zillow_cox[zillow_cox$ne_cutoff== -0.1,]$median_forc_time,na.rm = TRUE)
lpm_coef[lpm_coef$x=="interestrate",'value'] = mean(zillow_cox[zillow_cox$ne_cutoff== -0.1,]$interestrate,na.rm = TRUE)
lpm_coef[lpm_coef$x=="age_t",'value'] = 0 #mean(zillow_cox[zillow_cox$ne_cutoff== -0.1,]$age_t,na.rm = TRUE)
lpm_coef[lpm_coef$x=="fico",'value'] = mean(zillow_cox[zillow_cox$ne_cutoff== -0.1,]$fico,na.rm = TRUE)
lpm_coef[lpm_coef$x=="ltv",'value'] = mean(zillow_cox[zillow_cox$ne_cutoff== -0.1,]$ltv,na.rm = TRUE)
lpm_coef[lpm_coef$x=="dti",'value'] = mean(zillow_cox[zillow_cox$ne_cutoff== -0.1,]$dti,na.rm = TRUE)
lpm_coef[lpm_coef$x=="upb",'value'] = mean(zillow_cox[zillow_cox$ne_cutoff== -0.1,]$upb,na.rm = TRUE)

lpm_coef[lpm_coef$x=="adjusted_mpay_rent",'value'] = 0.5


x = seq(0.6,2,0.1)
y = rep(NA, length(x))

for(i in 1:length(x))  {
  lpm_coef[lpm_coef$x=="adjusted_mpay_rent",'value'] = x[i]
  lpm_coef['pred'] <- lpm_coef$Estimate*lpm_coef$value
  y[i]= sum(lpm_coef$pred)+factor_zip+factor_ne_year
}

plot_data <- as.data.frame(cbind(x,y))

ggplot(plot_data,aes(x=x,y=y))+geom_point()+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+labs(x = "mpay/rent",y="Predicted probability of default")+ theme_bw()


```

### Hazard Contribution
```{r hazardgraph}

cox_formula <- as.formula("Surv(duration,def)~adjusted_mpay_rent+I(adjusted_mpay_rent^2)+I(adjusted_mpay_rent^3)+I(adjusted_mpay_rent^4)+I(adjusted_mpay_rent^5)+median_forc_time+interest_diff+age_t+age_t*age_t+factor(ne_year)+fico+ltv+dti+medhhincome+medhouseage+vacantpct+bachelorpct+withsalarypct+factor(occupancy)+factor(purpose)+factor(state)+factor(ne_cutoff)+log(upb)/ltv+mpay/dti+default_pct+hpi_change+forc_pct")

cox <- coxph(cox_formula,data = zillow_cox,control = coxph.control(iter.max = 100))

x = (80:200)/100
y = exp((summary(cox)$coefficients)[1,1] * x +(summary(cox)$coefficients)[2,1] * x^2 +(summary(cox)$coefficients)[3,1] * x^3 +(summary(cox)$coefficients)[4,1] * x^4 +(summary(cox)$coefficients)[5,1] * x^5)
plot_data <- as.data.frame(cbind(x,y))

ggplot(plot_data,aes(x=x,y=y))+geom_point()+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+labs(x = "mpay/rent",y="Proportional Hazard Contribution")+ theme_bw()

cox <- NULL
gc( verbose = FALSE)

cox_formula <- as.formula("Surv(duration,def)~factor((adjusted_mpay_rent %/% 0.1)/10)+median_forc_time+interest_diff+age_t+age_t*age_t+factor(ne_year)+fico+ltv+dti+medhhincome+medhouseage+vacantpct+bachelorpct+withsalarypct+factor(occupancy)+factor(purpose)+factor(state)+factor(ne_cutoff)+log(upb)/ltv+mpay/dti+default_pct+hpi_change+forc_pct")

cox <- coxph(cox_formula,data = zillow_cox,control = coxph.control(iter.max = 100))

x = seq(0.8,2,0.1)
y = as.vector((summary(cox)$coefficients)[7:19,1])
plot_data <- as.data.frame(cbind(x,y))

ggplot(plot_data,aes(x=x,y=y))+geom_point()+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+labs(x = "mpay/rent",y="Proportional Hazard Contribution")+ theme_bw()

cox <- NULL
gc( verbose = FALSE)
```

### Two Stage Least Squres
Using the <b>10% negative equity subsample</b>. Similar results for other negative equity subsamples and for the combined sample.

<b>Diagnostic tests:</b><br/>
Weak instruments : statistic 2664.73; p-value  < 2e-16 ***<br/>
Wu-Hausman : statistic 43.26; p-value 4.84e-11 ***
```{r tsls}
temp <- zillow_cox[zillow_cox$ne_cutoff==-0.1,]
temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
temp['org_qt']<-as.yearqtr(as.Date(as.character(temp$orgdate)))
temp = temp[temp$loanterm==360,]
temp['current_hv_cat'] <- temp$current_housevalue %/% 25000
temp['zip_year'] <- paste(temp$zip,temp$ne_year,sep="_")

#temp2 <- ddply(temp,.(zip_year),summarise,obs = length(loanid))

#temp <- temp[temp$zip_year %in% temp2[temp2$obs<25,]$zip_year,]

iv_reg <- list()
iv_reg[[1]] <- lm(def ~ adjusted_mpay_rent + fico + ltv+ dti + log(upb) + current_hv_cat+interest_diff *factor(zip_year), data=temp)
iv_reg[[2]] <- ivreg(def ~ adjusted_mpay_rent +current_hv_cat+factor(zip_year) | interestrate_avg+age_t +current_hv_cat+factor(zip_year), data=temp)
iv_reg[[3]] <- ivreg(def ~ adjusted_mpay_rent + fico + ltv+ dti + log(upb) + current_hv_cat+interest_diff +factor(zip_year) | fico + ltv+ dti + log(upb) +current_hv_cat+ interestrate_avg+ interest_diff + age_t +factor(occupancy) + factor(purpose)+factor(zip_year), data=temp)
iv_reg[[4]] <- lm(adjusted_mpay_rent~interestrate_avg+age_t+fico + current_hv_cat+ltv+ dti + log(upb) + interest_diff + factor(zip_year) , data=temp)

stargazer(iv_reg,type = output.type,no.space = TRUE,omit = c("zip_year","purpose","occupancy"),omit.labels = c("zip * year","purpose","occupancy"),column.labels   = c("OLS","Two Stage", "First Stage"),   column.separate = c(1,2, 1),omit.stat = c("f","ser","rsq"))
```

### Two Stage Least Squres (m/r + m/r*(m/r >1) )

<b>Diagnostic tests:</b><br/>
Weak instruments (adjusted mpay rent) :   statistic  2664.729 ; p-value <2e-16 ***<br/>
Weak instruments (I(adjusted mpay rent > 1)TRUE) :   statistic 1249.276 ; p-value  <2e-16 ***<br/>
Weak instruments (adjusted mpay rent:I(adjusted mpay rent > 1)TRUE) :   statistic 1887.863; p-value   <2e-16 ***<br/>
Wu-Hausman  :  statistic   26.490; p-value   <2e-16 ***<br/>

```{r tslsinteraction}
setwd(file_path)
temp <- readRDS(file="ne_-10_cleaned.rds")

temp <- temp[!is.na(temp$adjusted_mpay_rent) & !is.na(temp$interestrate_avg) & !is.na(temp$age_t) & !is.na(temp$fico) & !is.na(temp$current_hv_cat) & !is.na(temp$ltv)  & !is.na(temp$dti)  & !is.na(temp$upb)  & !is.na(temp$interest_diff)  & !is.na(temp$zip_year),]

iv_reg <- list()
iv_reg[[1]] <- lm(adjusted_mpay_rent~interestrate_avg+age_t+fico + current_hv_cat+ltv+ dti + log(upb) + interest_diff + factor(zip_year) , data=temp)
temp['mpay_rent_hat'] <- predict(iv_reg[[1]],temp)
iv_reg[[2]] <- lm(def ~ mpay_rent_hat*I(mpay_rent_hat>1) + fico + ltv+ dti + log(upb) + current_hv_cat+interest_diff +factor(zip_year),data=temp)

stargazer(iv_reg,type = output.type,no.space = TRUE,omit = c("zip_year"),omit.labels = c("zip * year"),column.labels   = c("OLS","First Stage", "Second Stage"),   column.separate = c(1,1,2),omit.stat = c("f","ser","rsq"))
```

### Two Stage Least Squres (m/r + m/r*(m/r >1) ) Prediction
```{r tslsinteractionpred, echo=FALSE}
lpm_sum <- summary(iv_reg[[2]])
lpm_coef <- as.data.frame(lpm_sum$coefficients)
lpm_coef['x']<- row.names(lpm_coef)
lpm_coef$`Std. Error` <-NULL
lpm_coef$`t value` <- NULL

factor_zip_year <- median(lpm_coef[substr(lpm_coef$x,1,16)=="factor(zip_year)",]$Estimate,na.rm = TRUE)
lpm_coef <- lpm_coef[substr(lpm_coef$x,1,16)!="factor(zip_year)",]

lpm_coef['value'] <- NA
lpm_coef[lpm_coef$x=="(Intercept)",'value']=1
lpm_coef[lpm_coef$x=="fico",'value'] = mean(temp$fico,na.rm = TRUE)
lpm_coef[lpm_coef$x=="ltv",'value'] = mean(temp$ltv,na.rm = TRUE)
lpm_coef[lpm_coef$x=="dti",'value'] = mean(temp$dti,na.rm = TRUE)
lpm_coef[lpm_coef$x=="log(upb)",'value'] = log(mean(temp$upb,na.rm = TRUE))
lpm_coef[lpm_coef$x=="current_hv_cat",'value'] = mean(temp$current_hv_cat,na.rm = TRUE)
lpm_coef[lpm_coef$x=="interest_diff",'value'] = 0

lpm_coef[lpm_coef$x=="mpay_rent_hat",'value'] = 0.5
lpm_coef[lpm_coef$x=="I(mpay_rent_hat > 1)TRUE",'value'] = 0
lpm_coef[lpm_coef$x=="mpay_rent_hat:I(mpay_rent_hat > 1)TRUE",'value'] = lpm_coef[lpm_coef$x=="mpay_rent_hat",'value']*lpm_coef[lpm_coef$x=="I(mpay_rent_hat > 1)TRUE",'value']

x = seq(0.6,2,0.025)
y = rep(NA, length(x))

for(i in 1:length(x))  {
  lpm_coef[lpm_coef$x=="mpay_rent_hat",'value'] = x[i]
  if(x[i]>1) ind =1
  else ind = 0 
  lpm_coef[lpm_coef$x=="I(mpay_rent_hat > 1)TRUE",'value'] = ind
  lpm_coef[lpm_coef$x=="mpay_rent_hat:I(mpay_rent_hat > 1)TRUE",'value'] = ind*x[i]
  lpm_coef['pred'] <- lpm_coef$Estimate*lpm_coef$value
  y[i]= sum(lpm_coef$pred)+factor_zip_year
}

plot_data <- as.data.frame(cbind(x,y))

ggplot(plot_data,aes(x=x,y=y))+geom_point()+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+labs(x = "mpay/rent",y="Predicted probability of default")+ theme_bw()

```

### Two Stage Least Squres - <b>Matched</b> 10% positive equity 

```{r tslsposeqty, echo=FALSE}

setwd(file_path)
pos_eqty <- readRDS("cox_ne_0.1_Dec082016.rds")
pos_eqty <- pos_eqty[!duplicated(pos_eqty[,c("loanid","ne_cutoff")]),]
pos_eqty <- pos_eqty[!is.na(pos_eqty$adjusted_mpay_rent),]
#pos_eqty <- pos_eqty[pos_eqty$adjusted_mpay_rent>1,]
pos_eqty['org_qt']<-as.yearqtr(as.Date(as.character(pos_eqty$orgdate)))
interestrate_zip <- readRDS("interestrate_zip.rds")
pos_eqty <- merge(pos_eqty,interestrate_zip,by=c("zip","org_qt"),all.x = TRUE)
pos_eqty['interest_diff'] <- (pos_eqty$interestrate - pos_eqty$interestrate_avg)/pos_eqty$interestrate_avg
temp  <- zillow_cox[zillow_cox$ne_cutoff==-0.1,]
temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
temp <- temp[!is.na(temp$adjusted_mpay_rent),]
#temp <- temp[temp$adjusted_mpay_rent>1,]
temp <- temp[,names(pos_eqty)]
pos_eqty <- rbind(pos_eqty,temp)

pos_eqty['Tr'] <- ifelse(pos_eqty$ne_cutoff==-0.1,1,0)

pos_eqty <- pos_eqty[!is.na(pos_eqty$fico) & !is.na(pos_eqty$upb) & !is.na(pos_eqty$interestrate) &  !is.na(pos_eqty$zip) & !is.na(pos_eqty$ne_qt),]

Tr <- pos_eqty$Tr
Y <- pos_eqty$def

glm_prop <- glm(Tr~fico+log(upb)+interestrate,data=pos_eqty,family = 'binomial')
propensity <- Matchby(Y=Y,Tr=Tr,by=list(pos_eqty$zip,pos_eqty$ne_qt),X=glm_prop$fitted.values,M=1,replace = FALSE,print.level = 0)


temp <- pos_eqty[propensity$index.control,]
temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
temp['org_qt']<-as.yearqtr(as.Date(as.character(temp$orgdate)))
temp = temp[temp$loanterm==360,]
temp['current_hv_cat'] <- temp$current_housevalue %/% 25000
temp['zip_year'] <- paste(temp$zip,temp$ne_year,sep="_")


#temp2 <- ddply(temp,.(zip_year),summarise,obs = length(loanid))

#temp <- temp[temp$zip_year %in% temp2[temp2$obs<25,]$zip_year,]

iv_reg <- list()
iv_reg[[1]] <- lm(def ~ adjusted_mpay_rent + fico + ltv+ dti + log(upb) + current_hv_cat+interest_diff *factor(zip_year), data=temp)
iv_reg[[2]] <- ivreg(def ~ adjusted_mpay_rent +current_hv_cat+factor(zip_year) | interestrate_avg+age_t +current_hv_cat+factor(zip_year), data=temp)
iv_reg[[3]] <- ivreg(def ~ adjusted_mpay_rent + fico + ltv+ dti + log(upb) + current_hv_cat+interest_diff +factor(zip_year) | fico + ltv+ dti + log(upb) +current_hv_cat+ interestrate_avg+ interest_diff + age_t +factor(occupancy) + factor(purpose)+factor(zip_year), data=temp)
iv_reg[[4]] <- lm(adjusted_mpay_rent~interestrate_avg+age_t+fico + current_hv_cat+ltv+ dti + log(upb) + interest_diff + factor(zip_year) , data=temp)

stargazer(iv_reg,type = output.type,no.space = TRUE,omit = c("zip_year","purpose","occupancy"),omit.labels = c("zip * year","purpose","occupancy"),column.labels   = c("OLS","Two Stage", "First Stage"),   column.separate = c(1,2, 1),omit.stat = c("f","ser","rsq"))
```

### Two Stage Least Squres - <b>Matched</b> 10% positive equity & mpay/rent > 1

```{r tslsposeqtygt1, echo=FALSE}

setwd(file_path)
pos_eqty <- readRDS("cox_ne_0.1_Dec082016.rds")
pos_eqty <- pos_eqty[!duplicated(pos_eqty[,c("loanid","ne_cutoff")]),]
pos_eqty <- pos_eqty[!is.na(pos_eqty$adjusted_mpay_rent),]
pos_eqty <- pos_eqty[pos_eqty$adjusted_mpay_rent>1,]
pos_eqty['org_qt']<-as.yearqtr(as.Date(as.character(pos_eqty$orgdate)))
interestrate_zip <- readRDS("interestrate_zip.rds")
pos_eqty <- merge(pos_eqty,interestrate_zip,by=c("zip","org_qt"),all.x = TRUE)
pos_eqty['interest_diff'] <- (pos_eqty$interestrate - pos_eqty$interestrate_avg)/pos_eqty$interestrate_avg
temp  <- zillow_cox[zillow_cox$ne_cutoff==-0.1,]
temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
temp <- temp[!is.na(temp$adjusted_mpay_rent),]
temp <- temp[temp$adjusted_mpay_rent>1,]
temp <- temp[,names(pos_eqty)]
pos_eqty <- rbind(pos_eqty,temp)

pos_eqty['Tr'] <- ifelse(pos_eqty$ne_cutoff==-0.1,1,0)

pos_eqty <- pos_eqty[!is.na(pos_eqty$fico) & !is.na(pos_eqty$upb) & !is.na(pos_eqty$interestrate) &  !is.na(pos_eqty$zip) & !is.na(pos_eqty$ne_qt),]

Tr <- pos_eqty$Tr
Y <- pos_eqty$def

glm_prop <- glm(Tr~fico+log(upb)+interestrate,data=pos_eqty,family = 'binomial')
propensity <- Matchby(Y=Y,Tr=Tr,by=list(pos_eqty$zip,pos_eqty$ne_qt),X=glm_prop$fitted.values,M=5,replace = FALSE,print.level = 0)


temp <- pos_eqty[propensity$index.control,]
temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
temp['org_qt']<-as.yearqtr(as.Date(as.character(temp$orgdate)))
temp = temp[temp$loanterm==360,]
temp['current_hv_cat'] <- temp$current_housevalue %/% 25000
temp['zip_year'] <- paste(temp$zip,temp$ne_year,sep="_")


#temp2 <- ddply(temp,.(zip_year),summarise,obs = length(loanid))

#temp <- temp[temp$zip_year %in% temp2[temp2$obs<25,]$zip_year,]

iv_reg <- list()
iv_reg[[1]] <- lm(def ~ adjusted_mpay_rent + fico + ltv+ dti + log(upb) + current_hv_cat+interest_diff *factor(zip_year), data=temp)
iv_reg[[2]] <- ivreg(def ~ adjusted_mpay_rent +current_hv_cat+factor(zip_year) | interestrate_avg+age_t +current_hv_cat+factor(zip_year), data=temp)
iv_reg[[3]] <- ivreg(def ~ adjusted_mpay_rent + fico + ltv+ dti + log(upb) + current_hv_cat+interest_diff +factor(zip_year) | fico + ltv+ dti + log(upb) +current_hv_cat+ interestrate_avg+ interest_diff + age_t +factor(occupancy) + factor(purpose)+factor(zip_year), data=temp)
iv_reg[[4]] <- lm(adjusted_mpay_rent~interestrate_avg+age_t+fico + current_hv_cat+ltv+ dti + log(upb) + interest_diff + factor(zip_year) , data=temp)

stargazer(iv_reg,type = output.type,no.space = TRUE,omit = c("zip_year","purpose","occupancy"),omit.labels = c("zip * year","purpose","occupancy"),column.labels   = c("OLS","Two Stage", "First Stage"),   column.separate = c(1,2, 1),omit.stat = c("f","ser","rsq"))
```

### low mpay_rent (<0.8) negative and positive equity default (Matched)
```{r posnegcom1,echo=FALSE}
setwd(file_path)
org  <- zillow_cox[zillow_cox$ne_cutoff==-0.2,]
org <- org[!duplicated(org[,c("loanid","ne_cutoff")]),]
org <- org[!is.na(org$adjusted_mpay_rent),]
org <- org[org$adjusted_mpay_rent<0.8,]
org['current_hv_cat'] <- org$current_housevalue %/% 25000
org['Tr'] <- 1
org <- org[,names(org)[!names(org) %in% c("temp","median_forc_time","mean_forc_time","rent_diff","ne_year","forc_pct","default_pct","hpi_change","mpay_rent","agents","prop_tax_pct","prop_tax_value","avg_school_rating","org_year")]]
res <- NULL
for(th in c(1,2,5)) {
  cat(th)
  data <- readRDS(paste("cox_ne_0.",th,"_Dec082016.rds",sep = ""))
  data <- data[!duplicated(data[,c("loanid","ne_cutoff")]),]
  data <- data[!is.na(data$adjusted_mpay_rent),]
  data <- data[data$adjusted_mpay_rent<0.8,]
  data['org_qt']<-as.yearqtr(as.Date(as.character(data$orgdate)))
  interestrate_zip <- readRDS("interestrate_zip.rds")
  data <- merge(data,interestrate_zip,by=c("zip","org_qt"),all.x = TRUE)
  data['interest_diff'] <- (data$interestrate - data$interestrate_avg)/data$interestrate_avg
  data['Tr']<-0
  data['current_hv_cat'] <- data$current_housevalue %/% 25000

  data <- data[,names(org)]
  data <- rbind(data,org)
  
  data <- data[!is.na(data$fico) & !is.na(data$upb) & !is.na(data$interestrate) & !is.na(data$zip) & !is.na(data$ne_qt) & !is.na(data$current_hv_cat),]
  Tr <- data$Tr
  Y <- data$def
  

  glm_prop <- glm(Tr~fico+log(upb)+interestrate+current_hv_cat,data=data,family = 'binomial')
  propensity <- Matchby(Y=Y,Tr=Tr,by=list(data$zip,data$ne_qt,data$current_hv_cat),X=glm_prop$fitted.values,print.level = 0,replace = TRUE,M=1)
  
  pos_eqty <- data[propensity$index.control,]
  
  data  <- zillow_cox[zillow_cox$ne_cutoff== (0-th/10),]
  data <- data[!duplicated(data[,c("loanid","ne_cutoff")]),]
  data <- data[!is.na(data$adjusted_mpay_rent),]
  data <- data[data$adjusted_mpay_rent<0.8,]
  data['Tr']<-0
  data <- data[,names(data)[!names(data) %in% c("temp","median_forc_time","mean_forc_time","rent_diff","ne_year","forc_pct","default_pct","hpi_change","mpay_rent","agents","prop_tax_pct","prop_tax_value","avg_school_rating","org_year")]]
 data['current_hv_cat'] <- data$current_housevalue %/% 25000
  data <- data[,names(org)]
  data <- rbind(data,org)
 
  
  data <- data[!is.na(data$fico) & !is.na(data$upb) & !is.na(data$interestrate) & !is.na(data$zip) & !is.na(data$ne_qt) & !is.na(data$current_hv_cat),]
  Tr <- data$Tr
  Y <- data$def
  

  glm_prop <- glm(Tr~fico+log(upb)+interestrate,data=data,family = 'binomial')
  tryCatch({propensity <- Matchby(Y=Y,Tr=Tr,by=list(data$current_hv_cat),X=glm_prop$fitted.values,print.level = 0,replace = TRUE,M=1)},error=function(cond) {})
  #tryCatch({record[4]<-temp[[3]]$getElementText()},error=function(cond) {})
  if(th==2) {
    neg_eqty = org
  } else neg_eqty <- data[propensity$index.control,]
  
  neg_eqty <- neg_eqty[,names(pos_eqty)]
  data <- rbind(pos_eqty,neg_eqty)
  s <- as.data.frame(ddply(data,.(ne_cutoff),summarise,default_pct = mean(def,na.rm = TRUE)))
  res <- rbind(res,cbind((th/10),t(as.vector(s$default_pct)),as.vector(t.test(data$def~data$ne_cutoff)$statistic)))
}

res <- as.data.frame(res)
names(res) <-  c("Equity","Negative","Positive","t-stat")
stargazer(res,type=output.type,summary = FALSE)

```

### high mpay_rent (>1.2) negative and positive equity default (Matched)
```{r posnegcom2,echo=FALSE}
setwd(file_path)
org  <- zillow_cox[zillow_cox$ne_cutoff==-0.2,]
org <- org[!duplicated(org[,c("loanid","ne_cutoff")]),]
org <- org[!is.na(org$adjusted_mpay_rent),]
org <- org[org$adjusted_mpay_rent>1.2,]
org['current_hv_cat'] <- org$current_housevalue %/% 25000
org['Tr'] <- 1
org <- org[,names(org)[!names(org) %in% c("temp","median_forc_time","mean_forc_time","rent_diff","ne_year","forc_pct","default_pct","hpi_change","mpay_rent","agents","prop_tax_pct","prop_tax_value","avg_school_rating","org_year")]]
res <- NULL
for(th in c(1,2,5)) {
 # cat(th)
  data <- readRDS(paste("cox_ne_0.",th,"_Dec082016.rds",sep = ""))
  data <- data[!duplicated(data[,c("loanid","ne_cutoff")]),]
  data <- data[!is.na(data$adjusted_mpay_rent),]
  data <- data[data$adjusted_mpay_rent>1.2,]
  data['org_qt']<-as.yearqtr(as.Date(as.character(data$orgdate)))
  interestrate_zip <- readRDS("interestrate_zip.rds")
  data <- merge(data,interestrate_zip,by=c("zip","org_qt"),all.x = TRUE)
  data['interest_diff'] <- (data$interestrate - data$interestrate_avg)/data$interestrate_avg
  data['Tr']<-0
  data['current_hv_cat'] <- data$current_housevalue %/% 25000

  data <- data[,names(org)]
  data <- rbind(data,org)
  
  data <- data[!is.na(data$fico) & !is.na(data$upb) & !is.na(data$interestrate) & !is.na(data$zip) & !is.na(data$ne_qt) & !is.na(data$current_hv_cat),]
  Tr <- data$Tr
  Y <- data$def
  

  glm_prop <- glm(Tr~fico+log(upb)+interestrate+current_hv_cat,data=data,family = 'binomial')
  propensity <- Matchby(Y=Y,Tr=Tr,by=list(data$zip,data$ne_qt,data$current_hv_cat),X=glm_prop$fitted.values,print.level = 0,replace = TRUE,M=1)
  
  pos_eqty <- data[propensity$index.control,]
  
  data  <- zillow_cox[zillow_cox$ne_cutoff== (0-th/10),]
  data <- data[!duplicated(data[,c("loanid","ne_cutoff")]),]
  data <- data[!is.na(data$adjusted_mpay_rent),]
  data <- data[data$adjusted_mpay_rent>1.2,]
  data['Tr']<-0
  data <- data[,names(data)[!names(data) %in% c("temp","median_forc_time","mean_forc_time","rent_diff","ne_year","forc_pct","default_pct","hpi_change","mpay_rent","agents","prop_tax_pct","prop_tax_value","avg_school_rating","org_year")]]
 data['current_hv_cat'] <- data$current_housevalue %/% 25000
  data <- data[,names(org)]
  data <- rbind(data,org)
 
  
  data <- data[!is.na(data$fico) & !is.na(data$upb) & !is.na(data$interestrate) & !is.na(data$zip) & !is.na(data$ne_qt) & !is.na(data$current_hv_cat),]
  Tr <- data$Tr
  Y <- data$def
  

  glm_prop <- glm(Tr~fico+log(upb)+interestrate,data=data,family = 'binomial')
  tryCatch({propensity <- Matchby(Y=Y,Tr=Tr,by=list(data$current_hv_cat),X=glm_prop$fitted.values,print.level = 0,replace = TRUE,M=1)},error=function(cond) {})
  #tryCatch({record[4]<-temp[[3]]$getElementText()},error=function(cond) {})
  if(th==2) {
    neg_eqty = org
  } else neg_eqty <- data[propensity$index.control,]
  
  neg_eqty <- neg_eqty[,names(pos_eqty)]
  data <- rbind(pos_eqty,neg_eqty)
  s <- as.data.frame(ddply(data,.(ne_cutoff),summarise,default_pct = mean(def,na.rm = TRUE)))
  res <- rbind(res,cbind((th/10),t(as.vector(s$default_pct)),as.vector(t.test(data$def~data$ne_cutoff)$statistic)))
}


res <- as.data.frame(res)
names(res) <-  c("Equity","Negative","Positive","t-stat")
stargazer(res,type=output.type,summary = FALSE)

```

### low mpay_rent (<0.8) negative (10%) and positive(10%) equity default (Matched)
Exactly match by: zip,ne_qt, current house value category
```{r posnegcom1,echo=FALSE}
setwd(file_path)
pos_eqty <- readRDS("cox_ne_0.1_Dec082016.rds")
pos_eqty <- pos_eqty[!duplicated(pos_eqty[,c("loanid","ne_cutoff")]),]
pos_eqty <- pos_eqty[!is.na(pos_eqty$adjusted_mpay_rent),]
pos_eqty <- pos_eqty[pos_eqty$adjusted_mpay_rent<0.8,]
pos_eqty['org_qt']<-as.yearqtr(as.Date(as.character(pos_eqty$orgdate)))
interestrate_zip <- readRDS("interestrate_zip.rds")
pos_eqty <- merge(pos_eqty,interestrate_zip,by=c("zip","org_qt"),all.x = TRUE)
pos_eqty['interest_diff'] <- (pos_eqty$interestrate - pos_eqty$interestrate_avg)/pos_eqty$interestrate_avg
temp  <- zillow_cox[zillow_cox$ne_cutoff==-0.1,]
temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
temp <- temp[!is.na(temp$adjusted_mpay_rent),]
temp <- temp[temp$adjusted_mpay_rent<0.8,]
temp <- temp[,names(pos_eqty)]
pos_eqty <- rbind(pos_eqty,temp)
pos_eqty['current_hv_cat'] <- pos_eqty$current_housevalue %/% 25000
pos_eqty['Tr'] <- ifelse(pos_eqty$ne_cutoff==-0.1,1,0)

pos_eqty <- pos_eqty[!is.na(pos_eqty$fico) & !is.na(pos_eqty$upb) & !is.na(pos_eqty$interestrate) &  !is.na(pos_eqty$zip) & !is.na(pos_eqty$ne_qt),]

Tr <- pos_eqty$Tr
Y <- pos_eqty$def

glm_prop <- glm(Tr~fico+log(upb)+interestrate,data=pos_eqty,family = 'binomial')
propensity <- Matchby(Y=Y,Tr=Tr,by=list(pos_eqty$zip,pos_eqty$ne_qt,pos_eqty$current_hv_cat),X=glm_prop$fitted.values,print.level = 0,replace = TRUE,M=1)
#propensity <- Match(Y=Y,Tr=Tr,X=glm_prop$fitted.values,ties = FALSE)

MatchBalance(Tr~def,match.out = propensity,nboots = 0,data=pos_eqty,paired = TRUE)
```

### low mpay_rent (<0.8) negative (20%) and positive(20%) equity default (Matched)
```{r posnegcom2,echo=FALSE}
setwd(file_path)
pos_eqty <- readRDS("cox_ne_0.2_Dec082016.rds")
pos_eqty <- pos_eqty[!duplicated(pos_eqty[,c("loanid","ne_cutoff")]),]
pos_eqty <- pos_eqty[!is.na(pos_eqty$adjusted_mpay_rent),]
pos_eqty <- pos_eqty[pos_eqty$adjusted_mpay_rent<0.8,]
pos_eqty['org_qt']<-as.yearqtr(as.Date(as.character(pos_eqty$orgdate)))
interestrate_zip <- readRDS("interestrate_zip.rds")
pos_eqty <- merge(pos_eqty,interestrate_zip,by=c("zip","org_qt"),all.x = TRUE)
pos_eqty['interest_diff'] <- (pos_eqty$interestrate - pos_eqty$interestrate_avg)/pos_eqty$interestrate_avg
temp  <- zillow_cox[zillow_cox$ne_cutoff==-0.2,]
temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
temp <- temp[!is.na(temp$adjusted_mpay_rent),]
temp <- temp[temp$adjusted_mpay_rent<0.8,]
temp <- temp[,names(pos_eqty)]
pos_eqty <- rbind(pos_eqty,temp)
pos_eqty['current_hv_cat'] <- pos_eqty$current_housevalue %/% 25000
pos_eqty['Tr'] <- ifelse(pos_eqty$ne_cutoff==-0.2,1,0)

pos_eqty <- pos_eqty[!is.na(pos_eqty$fico) & !is.na(pos_eqty$upb) & !is.na(pos_eqty$interestrate) &  !is.na(pos_eqty$zip) & !is.na(pos_eqty$ne_qt),]

Tr <- pos_eqty$Tr
Y <- pos_eqty$def

glm_prop <- glm(Tr~fico+log(upb)+interestrate+current_hv_cat,data=pos_eqty,family = 'binomial')
propensity <- Matchby(Y=Y,Tr=Tr,by=list(pos_eqty$zip,pos_eqty$ne_qt,pos_eqty$current_hv_cat),X=glm_prop$fitted.values,print.level = 0,replace = TRUE,M=1)
#propensity <- Match(Y=Y,Tr=Tr,X=glm_prop$fitted.values,ties = FALSE)

MatchBalance(Tr~def,match.out = propensity,nboots = 0,data=pos_eqty,paired = TRUE)
```

### low mpay_rent (<0.8) negative (50%) and positive(50%) equity default (Matched)
```{r posnegcom3,echo=FALSE}
setwd(file_path)
pos_eqty <- readRDS("cox_ne_0.5_Dec082016.rds")
pos_eqty <- pos_eqty[!duplicated(pos_eqty[,c("loanid","ne_cutoff")]),]
pos_eqty <- pos_eqty[!is.na(pos_eqty$adjusted_mpay_rent),]
pos_eqty <- pos_eqty[pos_eqty$adjusted_mpay_rent<0.8,]
pos_eqty['org_qt']<-as.yearqtr(as.Date(as.character(pos_eqty$orgdate)))
interestrate_zip <- readRDS("interestrate_zip.rds")
pos_eqty <- merge(pos_eqty,interestrate_zip,by=c("zip","org_qt"),all.x = TRUE)
pos_eqty['interest_diff'] <- (pos_eqty$interestrate - pos_eqty$interestrate_avg)/pos_eqty$interestrate_avg
temp  <- zillow_cox[zillow_cox$ne_cutoff==-0.5,]
temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
temp <- temp[!is.na(temp$adjusted_mpay_rent),]
temp <- temp[temp$adjusted_mpay_rent<0.8,]
temp <- temp[,names(pos_eqty)]
pos_eqty <- rbind(pos_eqty,temp)
pos_eqty['current_hv_cat'] <- pos_eqty$current_housevalue %/% 25000
pos_eqty['Tr'] <- ifelse(pos_eqty$ne_cutoff==-0.5,1,0)

pos_eqty <- pos_eqty[!is.na(pos_eqty$fico) & !is.na(pos_eqty$upb) & !is.na(pos_eqty$interestrate) &  !is.na(pos_eqty$zip) & !is.na(pos_eqty$ne_qt),]

Tr <- pos_eqty$Tr
Y <- pos_eqty$def

glm_prop <- glm(Tr~fico+log(upb)+interestrate,data=pos_eqty,family = 'binomial')
propensity <- Matchby(Y=Y,Tr=Tr,by=list(pos_eqty$zip,pos_eqty$ne_qt,pos_eqty$current_hv_cat),X=glm_prop$fitted.values,print.level = 0,replace = TRUE,M=1)
#propensity <- Match(Y=Y,Tr=Tr,X=glm_prop$fitted.values,ties = FALSE)

MatchBalance(Tr~def,match.out = propensity,nboots = 0,data=pos_eqty,paired = TRUE)
```

### high mpay_rent (>1.2) negative (10%) and positive(10%) equity default (Matched)
```{r posnegcom4,echo=FALSE}
setwd(file_path)
pos_eqty <- readRDS("cox_ne_-0.01_Dec082016.rds")
pos_eqty <- pos_eqty[!duplicated(pos_eqty[,c("loanid","ne_cutoff")]),]
pos_eqty <- pos_eqty[!is.na(pos_eqty$adjusted_mpay_rent),]
pos_eqty <- pos_eqty[pos_eqty$adjusted_mpay_rent>1.2,]
pos_eqty['org_qt']<-as.yearqtr(as.Date(as.character(pos_eqty$orgdate)))
interestrate_zip <- readRDS("interestrate_zip.rds")
pos_eqty <- merge(pos_eqty,interestrate_zip,by=c("zip","org_qt"),all.x = TRUE)
pos_eqty['interest_diff'] <- (pos_eqty$interestrate - pos_eqty$interestrate_avg)/pos_eqty$interestrate_avg
temp  <- zillow_cox[zillow_cox$ne_cutoff==-0.1,]
temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
temp <- temp[!is.na(temp$adjusted_mpay_rent),]
temp <- temp[temp$adjusted_mpay_rent>1.2,]
temp <- temp[,names(pos_eqty)]
pos_eqty <- rbind(pos_eqty,temp)
pos_eqty['current_hv_cat'] <- pos_eqty$current_housevalue %/% 25000
pos_eqty['Tr'] <- ifelse(pos_eqty$ne_cutoff==-0.1,1,0)

pos_eqty <- pos_eqty[!is.na(pos_eqty$fico) & !is.na(pos_eqty$upb) & !is.na(pos_eqty$interestrate) &  !is.na(pos_eqty$zip) & !is.na(pos_eqty$ne_qt),]

Tr <- pos_eqty$Tr
Y <- pos_eqty$def

glm_prop <- glm(Tr~fico+interest_diff+current_hv_cat,data=pos_eqty,family = 'binomial')
propensity <- Matchby(Y=Y,Tr=Tr,by=list(pos_eqty$state,pos_eqty$ne_qt,pos_eqty$current_hv_cat),X=glm_prop$fitted.values,print.level = 0,replace = FALSE,M=1)
#propensity <- Match(Y=Y,Tr=Tr,X=glm_prop$fitted.values,ties = FALSE)

MatchBalance(Tr~def,match.out = propensity,nboots = 0,data=pos_eqty,paired = TRUE)
```

### high mpay_rent (>1.2) negative (20%) and positive(20%) equity default (Matched)
```{r posnegcom5,echo=FALSE}
setwd(file_path)
pos_eqty <- readRDS("cox_ne_0.2_Dec082016.rds")
pos_eqty <- pos_eqty[!duplicated(pos_eqty[,c("loanid","ne_cutoff")]),]
pos_eqty <- pos_eqty[!is.na(pos_eqty$adjusted_mpay_rent),]
pos_eqty <- pos_eqty[pos_eqty$adjusted_mpay_rent>1.2,]
pos_eqty['org_qt']<-as.yearqtr(as.Date(as.character(pos_eqty$orgdate)))
interestrate_zip <- readRDS("interestrate_zip.rds")
pos_eqty <- merge(pos_eqty,interestrate_zip,by=c("zip","org_qt"),all.x = TRUE)
pos_eqty['interest_diff'] <- (pos_eqty$interestrate - pos_eqty$interestrate_avg)/pos_eqty$interestrate_avg
temp  <- zillow_cox[zillow_cox$ne_cutoff==-0.2,]
temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
temp <- temp[!is.na(temp$adjusted_mpay_rent),]
temp <- temp[temp$adjusted_mpay_rent>1.2,]
temp <- temp[,names(pos_eqty)]
pos_eqty <- rbind(pos_eqty,temp)
pos_eqty['current_hv_cat'] <- pos_eqty$current_housevalue %/% 25000
pos_eqty['Tr'] <- ifelse(pos_eqty$ne_cutoff==-0.2,1,0)

pos_eqty <- pos_eqty[!is.na(pos_eqty$fico) & !is.na(pos_eqty$upb) & !is.na(pos_eqty$interestrate) &  !is.na(pos_eqty$zip) & !is.na(pos_eqty$ne_qt),]

Tr <- pos_eqty$Tr
Y <- pos_eqty$def

glm_prop <- glm(Tr~fico+interest_diff+current_hv_cat+factor(state),data=pos_eqty,family = 'binomial')
propensity <- Matchby(Y=Y,Tr=Tr,by=list(pos_eqty$ne_qt),X=glm_prop$fitted.values,print.level = 0,replace = TRUE,M=1)
#propensity <- Match(Y=Y,Tr=Tr,X=glm_prop$fitted.values,ties = FALSE)

MatchBalance(Tr~def,match.out = propensity,nboots = 0,data=pos_eqty,paired = TRUE)
```

### high mpay_rent (>1.2) negative (50%) and positive(50%) equity default (Matched)
```{r posnegcom6,echo=FALSE}
setwd(file_path)
pos_eqty <- readRDS("cox_ne_0.5_Dec082016.rds")
pos_eqty <- pos_eqty[!duplicated(pos_eqty[,c("loanid","ne_cutoff")]),]
pos_eqty <- pos_eqty[!is.na(pos_eqty$adjusted_mpay_rent),]
pos_eqty <- pos_eqty[pos_eqty$adjusted_mpay_rent>1.2,]
pos_eqty['org_qt']<-as.yearqtr(as.Date(as.character(pos_eqty$orgdate)))
interestrate_zip <- readRDS("interestrate_zip.rds")
pos_eqty <- merge(pos_eqty,interestrate_zip,by=c("zip","org_qt"),all.x = TRUE)
pos_eqty['interest_diff'] <- (pos_eqty$interestrate - pos_eqty$interestrate_avg)/pos_eqty$interestrate_avg
temp  <- zillow_cox[zillow_cox$ne_cutoff==-0.5,]
temp <- temp[!duplicated(temp[,c("loanid","ne_cutoff")]),]
temp <- temp[!is.na(temp$adjusted_mpay_rent),]
temp <- temp[temp$adjusted_mpay_rent>1.2,]
temp <- temp[,names(pos_eqty)]
pos_eqty <- rbind(pos_eqty,temp)
pos_eqty['current_hv_cat'] <- pos_eqty$current_housevalue %/% 25000
pos_eqty['Tr'] <- ifelse(pos_eqty$ne_cutoff==-0.5,1,0)

pos_eqty <- pos_eqty[!is.na(pos_eqty$fico) & !is.na(pos_eqty$upb) & !is.na(pos_eqty$interestrate) &  !is.na(pos_eqty$zip) & !is.na(pos_eqty$ne_qt),]

Tr <- pos_eqty$Tr
Y <- pos_eqty$def

glm_prop <- glm(Tr~fico+log(upb)+interestrate,data=pos_eqty,family = 'binomial')
propensity <- Matchby(Y=Y,Tr=Tr,by=list(pos_eqty$zip,pos_eqty$ne_qt,pos_eqty$current_hv_cat),X=glm_prop$fitted.values,print.level = 0,replace = TRUE,M=1)
#propensity <- Match(Y=Y,Tr=Tr,X=glm_prop$fitted.values,ties = FALSE)

MatchBalance(Tr~def,match.out = propensity,nboots = 0,data=pos_eqty,paired = TRUE)
```

### Zipcode level regression: default % ~ median mpay_rent

```{r zipreg}
median_mpay_zillow <- ddply(zillow_cox,.(ne_qt,ne_cutoff,recourse,state,zip),summarise,
                     def=mean(def,na.rm = TRUE),
                     adjusted_mpay_rent = mean(adjusted_mpay_rent,na.rm = TRUE),
                     fico = mean(fico,na.rm = TRUE),
                     ltv = mean(ltv,na.rm = TRUE),
                     dti = mean(dti,na.rm = TRUE),
                     ne_year = mean(ne_year,na.rm = TRUE),
                     upb = mean(upb,na.rm = TRUE),
                     age_t = mean(age_t, na.rm = TRUE),
                     medhhincome = mean(medhhincome,na.rm = TRUE),
                     medhouseage = mean(medhouseage,na.rm = TRUE),
                     vacantpct = mean(vacantpct,na.rm = TRUE),
                     median_forc_time = mean(median_forc_time,na.rm = TRUE),
                     bachelorpct = mean(bachelorpct,na.rm = TRUE),
                     withsalarypct = mean(withsalarypct,na.rm = TRUE),
                     interest_diff = mean(interest_diff,na.rm = TRUE),
                     default_pct=mean(default_pct,na.rm = TRUE),
                     hpi_change = mean(hpi_change,na.rm=TRUE),
                     forc_pct = mean(forc_pct,na.rm = TRUE),
                     obs = length(loanid))



median_mpay_zillow['low_obs']<-ifelse(median_mpay_zillow$obs<5,1,0)

ddply(median_mpay_zillow,.(low_obs),summarise,ltv = mean(ltv,na.rm = TRUE),ltv = mean(ltv,na.rm = TRUE),interest_diff=mean(interest_diff,na.rm = TRUE))
ols <- list()
se <- list()
marginal_effects <- list()

ols_formula <- as.formula("def~adjusted_mpay_rent+interest_diff+median_forc_time+factor(state)+fico+ltv+dti+log(upb)+medhhincome+medhouseage+vacantpct+bachelorpct+withsalarypct+default_pct+hpi_change+forc_pct")


ols[[1]]<-lm(ols_formula,data=median_mpay_zillow[median_mpay_zillow$ne_cutoff==-0.01,])
se[[1]] <- sqrt(diag(vcovHAC(ols[[1]])))

marginal_effects[[1]] <- summary(ols[[1]])$coefficients[2]*sd(median_mpay_zillow[median_mpay_zillow$ne_cutoff==-0.01,]$adjusted_mpay_rent)

ols[[2]]<-lm(ols_formula,data=median_mpay_zillow[median_mpay_zillow$ne_cutoff==-0.1,])
se[[2]] <- sqrt(diag(vcovHAC(ols[[2]])))

marginal_effects[[2]] <- summary(ols[[2]])$coefficients[2]*sd(median_mpay_zillow[median_mpay_zillow$ne_cutoff==-0.1,]$adjusted_mpay_rent)

stargazer(ols, omit = c("state","ne_qt","ne_cutoff"), column.labels=c('NE 0','NE -10%'), omit.labels = c("State","Time","Negative Equity"), type=output.type,no.space=TRUE,se=se,omit.stat = c("f","ser"),add.lines = list(c("Marginal Effect (per 1sd)", round(marginal_effects[[1]],3),round(marginal_effects[[2]],3))),notes = "~Robust SE")


```

### Zip code level sold pct and inventory number
Percentage Houses Sold in each 3 digit zip code and for sale inventory in each zip code
(Using the median age to calculate mpay)
```{r soldpct}

# created by zipcode_level_reg_freddie_zillow.R
decile_data <- readRDS(paste(file_path,"decile_stats_merged.rds",sep=""))
decile_data['new_default_pct']<- decile_data$freddie_no_of_defaults*100/decile_data$freddie_no_of_loans
decile_data$ne_default_pct=decile_data$ne_default_pct*100

stargazer(
  decile_data[decile_data$age_decile==5, c("sold_pct","ne_default_pct","inventory_value","mpay_rent","mpay","rent")], type = output.type, 
  summary.stat = c("mean", "sd","min", "p25", "median", "p75", "max")
)

ols <- list()
se <-list()
ols[[1]] <- lm(sold_pct~mpay_rent+fico+ltv+dti+medhhincome+medhouseage+vacantpct+bachelorpct+withsalarypct+age+factor(state)+factor(current_year),data=decile_data[decile_data$age_decile==5,])
  se[[1]] <-sqrt(diag(cluster.vcov(ols[[1]], cbind(decile_data[decile_data$age_decile==5,]$state,decile_data[decile_data$age_decile==5,]$current_year))))
stargazer(ols, omit = c("state","current_year"),omit.labels = c("State","Year"),type=output.type,no.space=TRUE,notes = "~SE Clusterd by state and time")

```

### Prepayment Loanmonth
```{r prepay}
# rm(list=ls())
# library(data.table)
# library(zoo)
# library(sqldf)
# library(stargazer)
# library(survival)
# library(reshape2)
# library(zipcode)
# library(ggplot2)
# library(multiwayvcov)
# library(sandwich)
# library(AER)
# file_path = "E:/strategic_default/"
# setwd(file_path)
# source("functions.R")
# output.type = "html"
# 
# 
# deldata_zillow <- readRDS(paste(file_path,"prepay_loanmonth_zillow.rds",sep=""))
# deldata_zillow['current_year'] <- as.numeric(format(deldata_zillow$reportingperiod_t,"%Y"))
# 
# gc(reset = TRUE)
# 
# logit <- list()
# logit[[1]] <- glm(prepaid~mpay_zillow_rent+interestrate+current_equity+I(age_t)+I(age_t^2)+I(age_t^3)+I(age_t^4)+I(age_t^5)+fico+ltv+dti+interestrate+factor(state)+factor(current_year),family='binomial',data=deldata_zillow,maxit=100)
# logit[[2]] <- glm(prepaid~mpay_zillow_rent+interestrate+current_equity+I(age_t)+I(age_t^2)+I(age_t^3)+I(age_t^4)+I(age_t^5)+fico+ltv+dti+interestrate+factor(state)+factor(current_year),family='binomial',data=deldata_zillow[deldata_zillow$current_equity>=0,],maxit=100)
# 
# stargazer(logit,type=output.type,no.space=TRUE,omit = c("state","current_year"),omit.labels = c("State","Year"),column.labels=c('All','Positive Equity'))


# ===============================================
#                        Dependent variable:     
#                   -----------------------------
#                              prepaid           
#                        All      Positive Equity
#                        (1)            (2)      
# -----------------------------------------------
# mpay_zillow_rent    0.596***       0.507***    
#                      (0.015)        (0.016)    
# interestrate        0.015***       0.019***    
#                      (0.005)        (0.006)    
# current_equity      0.662***       0.431***    
#                      (0.017)        (0.024)    
# I(age_t)            0.114***       0.123***    
#                      (0.003)        (0.003)    
# I(age_t2)           -0.003***      -0.003***   
#                     (0.0001)       (0.0001)    
# I(age_t3)          0.00003***     0.00003***   
#                     (0.00000)      (0.00000)   
# I(age_t4)          -0.00000***    -0.00000***  
#                      (0.000)        (0.000)    
# I(age_t5)           0.000***       0.000***    
#                      (0.000)        (0.000)    
# fico                0.004***       0.004***    
#                     (0.0001)       (0.0001)    
# ltv                 -0.002***      -0.003***   
#                     (0.0002)       (0.0003)    
# dti                 -0.003***      -0.003***   
#                     (0.0002)       (0.0002)    
# Constant            -9.362***      -8.932***   
#                      (0.131)        (0.134)    
# -----------------------------------------------
# State                  Yes            Yes      
# Year                   Yes            Yes      
# -----------------------------------------------
# Observations        8,631,740      7,538,121   
# Log Likelihood    -740,960.700   -656,376.900  
# Akaike Inf. Crit. 1,482,025.000  1,312,858.000 
# ===============================================
# Note:               *p<0.1; **p<0.05; ***p<0.01

```